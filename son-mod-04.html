<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPERCLAY // ORCHESTRATOR v13</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%23ff5000' stroke-width='8'/%3E%3C/svg%3E">
    <style>
        :root {
            /* ORCHESTRATOR THEME */
            --bg-void: #050505;
            --bg-panel: #0a0e14;
            --text-main: #e6fff9;
            --text-dim: #506070;
            --border: #1f2a35;
            --accent: #00ffff;
            
            --unit-h: 48px;
            --ease: cubic-bezier(0.25, 1, 0.5, 1);
        }

        [data-theme="light"] {
            /* HIGH CONTRAST LIGHT MODE */
            --bg-void: #e8e8ec;       /* Tech Grey */
            --bg-panel: #ffffff;      /* Pure White Cards */
            --text-main: #000000;     /* Pure Black Text */
            --text-dim: #555555;      /* Dark Grey Dim */
            --border: #bbbbbb;        /* Visible Borders */
            --accent: #ff4400;        /* Safety Orange */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: var(--bg-void); color: var(--text-main);
            font-family: 'Courier New', monospace; overflow: hidden;
            transition: background 0.3s;
        }

        #app { display: flex; flex-direction: column; height: 100%; }

        /* HEADER */
        #header {
            height: 40px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; background: var(--bg-panel); z-index: 50; flex-shrink: 0;
        }
        .brand { font-weight: 900; letter-spacing: 2px; font-size: 12px; color: var(--accent); }
        
        .ctrl-group { display: flex; gap: 10px; }
        .icon-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-dim);
            width: 24px; height: 24px; display: grid; place-items: center; cursor: pointer;
            border-radius: 4px; font-size: 12px; transition: all 0.2s;
        }
        .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
        .icon-btn.active { background: var(--accent); color: var(--bg-void); border-color: var(--accent); }

        /* SCROLL STAGE */
        #stage { flex-grow: 1; overflow-y: scroll; padding: 10px; position: relative; }
        #stage::-webkit-scrollbar { display: none; }

        /* UNIT LIST */
        #unit-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 100px; }
        #unit-list.grid-mode {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Wider for bezel */
            grid-auto-flow: dense;
        }

        /* UNIT BLADE */
        .unit {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
            display: flex; flex-direction: column;
            transition: all 0.3s var(--ease);
            position: relative;
        }
        
        #unit-list.grid-mode .unit { height: 180px; }
        #unit-list.grid-mode .unit.expanded {
            grid-column: span 2; grid-row: span 2; height: 500px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5); z-index: 10;
            border-color: var(--accent);
        }

        #unit-list:not(.grid-mode) .unit { height: var(--unit-h); }
        #unit-list:not(.grid-mode) .unit.expanded {
            height: 60vh; border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* UNIT HEADER */
        .unit-head {
            height: var(--unit-h); flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; cursor: pointer; user-select: none;
            border-bottom: 1px solid transparent; background: var(--bg-panel);
        }
        .unit.expanded .unit-head { border-bottom-color: var(--border); }
        .unit:hover .unit-head { background: rgba(255,255,255,0.02); }

        .unit-id { font-weight: bold; font-size: 13px; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 6px; height: 6px; background: var(--border); border-radius: 50%; }
        .unit.running .status-dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        .unit-type { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }

        /* IFRAME CONTAINER */
        .unit-body {
            flex-grow: 1; background: #000; position: relative;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .unit.expanded .unit-body { opacity: 1; pointer-events: auto; }

        iframe { width: 100%; height: 100%; border: none; display: block; }

    </style>
</head>
<body data-theme="dark">

<div id="app">
    <header id="header">
        <div class="brand">HYPERCLAY // BEZEL</div>
        <div class="ctrl-group">
            <div class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">◐</div>
            <div class="icon-btn" onclick="toggleGrid()" id="view-btn" title="Grid/List">⊞</div>
            <div class="icon-btn" onclick="collapseAll()" title="Collapse All">_</div>
        </div>
    </header>

    <div id="stage">
        <div id="unit-list">
            <!-- Units injected here -->
        </div>
    </div>
</div>

<script>
    // --- THE BEZEL UNIT PAYLOAD ---
    // Injected into iframes. Contains physics, audio, and bezel UI.
    const MODULE_SOURCE = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<style>
  :root { 
    --bez: 50px; 
    --c: #0ff; 
    --bg: #000;
    --fg: #222;
    --txt: #666;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { 
    margin: 0; background: var(--bg); overflow: hidden; 
    font-family: 'Courier New', monospace; 
    display: flex; width: 100vw; height: 100vh; 
  }

  /* LEFT BEZEL (Transport) */
  .bezel { 
    width: var(--bez); height: 100%; background: #080808; 
    border-right: 1px solid #333; 
    display: flex; flex-direction: column; 
    align-items: center; justify-content: center; gap: 10px; z-index: 10; 
  }
  .bezel.right { border-right: none; border-left: 1px solid #333; }

  /* CENTER (Clay) */
  .viewport { flex: 1; position: relative; background: #000; overflow: hidden; cursor: crosshair; }
  canvas { display: block; width: 100%; height: 100%; }

  /* SCANLINE */
  .scanline { 
    position: absolute; top: 0; bottom: 0; width: 2px; 
    background: var(--c); opacity: 0; pointer-events: none; 
    box-shadow: 0 0 10px var(--c); will-change: transform; 
  }
  .scanline.active { opacity: 0.8; }

  /* CONTROLS */
  .btn { 
    width: 36px; height: 36px; border: 1px solid #444; color: #666; 
    display: grid; place-items: center; font-size: 14px; cursor: pointer; 
    border-radius: 4px; transition: all 0.1s; background: #111; user-select: none; 
  }
  .btn:active { transform: scale(0.95); }
  .btn.active { border-color: var(--c); color: var(--c); background: rgba(0,255,255,0.1); box-shadow: 0 0 8px var(--c); }
  
  .label { 
    writing-mode: vertical-rl; text-orientation: mixed; 
    color: var(--c); font-size: 10px; letter-spacing: 2px; 
    opacity: 0.5; margin-top: 10px; pointer-events: none; 
  }

  /* FLASH */
  .flash { 
    position: absolute; inset: 0; background: var(--c); 
    opacity: 0; pointer-events: none; transition: opacity 0.1s; 
  }
</style>
</head>
<body>
  <!-- LEFT: TRANSPORT -->
  <div class="bezel">
    <div class="btn" id="btn-play">▶</div>
    <div class="label" id="lbl-type">UNIT</div>
  </div>

  <!-- CENTER: CLAY -->
  <div class="viewport">
    <canvas id="cv"></canvas>
    <div class="scanline" id="scan"></div>
    <div class="flash" id="flash"></div>
  </div>

  <!-- RIGHT: EDIT -->
  <div class="bezel right">
    <div class="btn" id="btn-clr" style="font-size:10px">CLR</div>
    <div class="btn" id="btn-mode" style="font-size:10px">EDIT</div>
  </div>

<script>
// --- CONFIG RECEIVER ---
const CFG = window.HC_CONFIG || { type:'sine', color:'#0ff', freq:220, speed:1.0 };
document.documentElement.style.setProperty('--c', CFG.color);
document.getElementById('lbl-type').innerText = CFG.type.toUpperCase();

// --- AUDIO ENGINE ---
const Audio = {
  ctx: null,
  init: () => {
    if(!Audio.ctx) Audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
    if(Audio.ctx.state === 'suspended') Audio.ctx.resume();
  },
  // Play sequence hit
  ping: (yRatio, intensity) => {
    if(!Audio.ctx) return;
    const t = Audio.ctx.currentTime;
    const osc = Audio.ctx.createOscillator();
    const gain = Audio.ctx.createGain();
    
    // Scale Logic
    const scale = [0, 3, 5, 7, 10, 12, 15, 17];
    const idx = Math.floor((1 - yRatio) * scale.length);
    const semitone = scale[Math.max(0, Math.min(idx, scale.length-1))];
    const freq = CFG.freq * Math.pow(2, semitone/12);

    // Timbre Switch
    if(CFG.type === 'kick') {
      osc.frequency.setValueAtTime(150, t);
      osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.3);
      gain.gain.setValueAtTime(intensity, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
    } else {
      osc.type = (CFG.type === 'bass') ? 'sawtooth' : (CFG.type === 'perc' ? 'square' : 'triangle');
      osc.frequency.setValueAtTime(freq, t);
      gain.gain.setValueAtTime(0, t);
      gain.gain.linearRampToValueAtTime(0.3 * intensity, t + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
    }

    osc.connect(gain);
    gain.connect(Audio.ctx.destination);
    osc.start(t);
    osc.stop(t+0.5);

    // Visual Flash
    const f = document.getElementById('flash');
    f.style.opacity = 0.2 * intensity;
    setTimeout(() => f.style.opacity = 0, 50);
  },
  // Sculpting noise (rubbing the clay)
  rub: (intensity) => {
    if(!Audio.ctx) return;
    const t = Audio.ctx.currentTime;
    const osc = Audio.ctx.createOscillator();
    const gain = Audio.ctx.createGain();
    osc.frequency.value = CFG.freq * 2; // Higher friction sound
    osc.type = 'triangle';
    osc.connect(gain);
    gain.connect(Audio.ctx.destination);
    gain.gain.setValueAtTime(0.05 * intensity, t);
    gain.gain.linearRampToValueAtTime(0, t+0.1);
    osc.start(t);
    osc.stop(t+0.1);
  }
};

// --- PHYSICS ---
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
let W, H;
let pts = []; 
const DENSITY = 16; 

function resize(){
  W = cv.parentElement.clientWidth;
  H = cv.parentElement.clientHeight;
  cv.width = W; cv.height = H;
  initMesh();
}

function initMesh(){
  pts = [];
  const rows = Math.floor(H / (W/DENSITY));
  for(let x=0; x<=DENSITY; x++){
    for(let y=0; y<=rows; y++){
      const px = (x/DENSITY) * W;
      const py = (y/rows) * H;
      pts.push({ x: px, y: py, ox: px, oy: py, active: false, hit: false });
    }
  }
}

function interact(mx, my, isPull){
  const rad = 50;
  let moveAmt = 0;
  pts.forEach(p => {
    const dx = p.x - mx;
    const dy = p.y - my;
    const dist = Math.sqrt(dx*dx + dy*dy); // optimize math
    if(dist < rad){
      const force = (1 - dist/rad) * 15;
      const angle = Math.atan2(dy, dx);
      const dir = isPull ? -1 : 1;
      p.x += Math.cos(angle) * force * dir;
      p.y += Math.sin(angle) * force * dir;
      if(Math.abs(p.x - p.ox) > 2 || Math.abs(p.y - p.oy) > 2) {
          p.active = true;
          moveAmt += force;
      }
    }
  });
  // Trigger sculpt sound if significant movement
  if(moveAmt > 5) Audio.rub(Math.min(moveAmt/100, 1));
}

function reset(){ pts.forEach(p => { p.x = p.ox; p.y = p.oy; p.active = false; }); }

// --- SEQUENCER LOOP ---
let playing = false;
let playhead = 0;
const scan = document.getElementById('scan');

function tick(){
  if(!playing) return;
  playhead += 0.008 * CFG.speed;
  if(playhead > 1) playhead = 0;
  
  const xPos = playhead * W;
  scan.style.transform = \`translateX(\${xPos}px)\`;
  
  const threshold = 10;
  pts.forEach(p => {
    if(p.active){
      if(Math.abs(p.x - xPos) < threshold && !p.hit){
        const deform = Math.hypot(p.x - p.ox, p.y - p.oy);
        const intensity = Math.min(deform / 40, 1);
        Audio.ping(p.y / H, intensity);
        p.hit = true;
      }
      if(Math.abs(p.x - xPos) > threshold) p.hit = false;
    }
  });
}

// --- DRAW ---
function loop(){
  requestAnimationFrame(loop);
  tick();
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle = CFG.color; ctx.lineWidth = 1; 
  ctx.beginPath();
  for(let i=0; i<pts.length; i++){
    const p = pts[i];
    // Draw horizontal/vertical neighbors
    // Simplified neighbor logic for flat array
    if(i+1 < pts.length && Math.abs(pts[i+1].ox - p.ox) < (W/DENSITY)*1.5) {
      ctx.moveTo(p.x, p.y); ctx.lineTo(pts[i+1].x, pts[i+1].y);
    }
    const below = i + (Math.floor(H / (W/DENSITY)) + 1);
    if(pts[below]) {
      ctx.moveTo(p.x, p.y); ctx.lineTo(pts[below].x, pts[below].y);
    }
  }
  ctx.stroke();
  
  // Highlight Active
  ctx.fillStyle = CFG.color;
  pts.forEach(p => { if(p.active) ctx.fillRect(p.x-1, p.y-1, 3, 3); });
}

// --- EVENTS ---
const btnPlay = document.getElementById('btn-play');
btnPlay.onclick = () => {
  playing = !playing;
  btnPlay.innerText = playing ? '■' : '▶';
  btnPlay.classList.toggle('active', playing);
  scan.classList.toggle('active', playing);
  Audio.init(); // Ensure audio context is ready
  window.parent.postMessage({type:'UNIT_STATE', id:CFG.id, running:playing}, '*');
};

document.getElementById('btn-clr').onclick = reset;

let isDragging = false;
cv.addEventListener('pointerdown', e => { isDragging = true; Audio.init(); interact(e.offsetX, e.offsetY, e.shiftKey); });
cv.addEventListener('pointermove', e => { if(isDragging) interact(e.offsetX, e.offsetY, e.shiftKey); });
cv.addEventListener('pointerup', () => isDragging = false);

window.addEventListener('resize', resize);
resize();
loop();
<\/script>
</body>
</html>
`;

    // --- ORCHESTRA DATA ---
    const UNITS = [
        { id: "A-01", type: "kick", color: "#ff4400", freq: 50, speed: 1.0 },
        { id: "A-02", type: "perc", color: "#ff4400", freq: 200, speed: 1.0 },
        { id: "A-03", type: "perc", color: "#ff4400", freq: 800, speed: 2.0 },
        { id: "B-01", type: "bass", color: "#0088ff", freq: 55, speed: 0.5 },
        { id: "B-02", type: "bass", color: "#0088ff", freq: 110, speed: 1.0 },
        { id: "C-01", type: "lead", color: "#00aa55", freq: 220, speed: 1.0 },
        { id: "C-02", type: "lead", color: "#00aa55", freq: 330, speed: 1.5 },
        { id: "D-01", type: "pad",  color: "#cc00ff", freq: 440, speed: 0.25 }
    ];

    const list = document.getElementById('unit-list');
    let gridMode = false;

    function init() {
        UNITS.forEach((u, i) => {
            const div = document.createElement('div');
            div.className = 'unit';
            div.id = `unit-${i}`;
            div.innerHTML = `
                <div class="unit-head" onclick="toggleUnit(${i})">
                    <div class="unit-id">
                        <div class="status-dot" id="dot-${i}"></div>
                        <span style="color:${u.color}">${u.id}</span>
                    </div>
                    <div class="unit-type">${u.type.toUpperCase()}</div>
                    <div class="mute-toggle" onclick="event.stopPropagation()">M</div>
                </div>
                <div class="unit-body">
                    <!-- Iframe injected here -->
                </div>
            `;
            list.appendChild(div);
        });
    }

    window.toggleUnit = (index) => {
        const unit = document.getElementById(`unit-${index}`);
        const body = unit.querySelector('.unit-body');
        const isActive = unit.classList.contains('expanded');

        if (isActive) {
            unit.classList.remove('expanded');
        } else {
            unit.classList.add('expanded');
            if (!body.querySelector('iframe')) {
                const u = UNITS[index];
                const iframe = document.createElement('iframe');
                
                // INJECT CONFIG
                const inject = `<script>window.HC_CONFIG={id:"${u.id}", type:"${u.type}", color:"${u.color}", freq:${u.freq}, speed:${u.speed}}<\/script>`;
                iframe.srcdoc = inject + MODULE_SOURCE;
                
                body.appendChild(iframe);
            }
        }
    };

    window.collapseAll = () => {
        document.querySelectorAll('.unit').forEach(u => u.classList.remove('expanded'));
    };

    window.toggleGrid = () => {
        gridMode = !gridMode;
        list.classList.toggle('grid-mode', gridMode);
        document.getElementById('view-btn').classList.toggle('active', gridMode);
    };

    window.toggleTheme = () => {
        const root = document.documentElement;
        const next = root.getAttribute('data-theme')==='light'?'dark':'light';
        root.setAttribute('data-theme', next);
    };

    // Listen for inner unit state changes
    window.addEventListener('message', (e) => {
        if(e.data.type === 'UNIT_STATE') {
            const units = document.querySelectorAll('.unit');
            units.forEach(u => {
                if(u.querySelector('.unit-id').textContent.includes(e.data.id)) {
                    if(e.data.running) u.classList.add('running');
                    else u.classList.remove('running');
                }
            });
        }
    });

    init();

</script>
</body>
</html>
