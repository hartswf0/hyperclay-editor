<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM BOOT // FUSE RADAR OS v.1.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
    <style>
        /*
        *   ARTIFACT: FUSE RADAR OS - INTERACTIVE PANELS
        *   ID: EXP-M-A-04
        *   CONCEPT: A bootable system loading one of three distinct, fully-functional
        *   FUSE radar interfaces, each with unique mechanics and aesthetics.
        */

        :root {
            --panel-bg: #1a1c1d;
            --panel-border: #333;
            --screen-bg: #0d120d;
            --grid-color: rgba(68, 153, 68, 0.2);
            --neon-green: #4f4;
            --neon-green-glow: rgba(80, 255, 80, 0.7);
            --amber: #ffb400;
            --amber-glow: rgba(255, 180, 0, 0.6);
            --text-color: #e0e0e0;
            --font-tech: 'Share Tech Mono', monospace;
            --font-pixel: 'VT323', monospace;
        }

        /* --- KEYFRAMES --- */
        @keyframes sweep { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes blink { 0%, 100% { background-color: var(--amber); box-shadow: 0 0 10px 2px var(--amber-glow); } 50% { background-color: #5a4200; box-shadow: none; } }
        @keyframes progress-flicker { 0% { opacity: 0.9; } 50% { opacity: 1; } 100% { opacity: 0.9; } }
        @keyframes ghost-trail { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 0; transform: scale(0.8); } }
        @keyframes terminal-boot-cursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- BASE & BOOT SCREEN --- */
        html, body {
            background-color: #080808;
            color: var(--text-color);
            font-family: var(--font-tech);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 1000;
        }

        #boot-screen {
            font-family: var(--font-pixel);
            text-align: center;
            color: var(--neon-green);
        }
        #boot-screen h1 { font-size: 3rem; margin: 0; }
        #boot-screen p { font-size: 1.5rem; color: #ccc; margin: 1rem 0; }
        #boot-screen p::after {
            content: '_';
            animation: terminal-boot-cursor 1s step-end infinite;
            margin-left: 5px;
        }
        .boot-options button {
            font-family: inherit; font-size: 1.5rem;
            background: transparent; border: 1px solid var(--neon-green);
            color: var(--neon-green); padding: 10px 20px;
            margin: 0 10px; cursor: pointer;
            transition: all 0.2s ease;
        }
        .boot-options button:hover { background-color: var(--neon-green-glow); color: #000; }

        /* --- PANEL LAYOUT --- */
        .panel-container {
            display: none; /* Hidden by default, shown by JS */
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            padding: 15px;
            width: 95vw;
            height: 95vh;
            max-width: 1200px;
            max-height: 800px;
            display: flex;
            flex-direction: column;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--panel-border);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .panel-title {
            font-family: var(--font-pixel);
            font-size: 1.8rem;
            color: var(--text-color);
        }
        .back-button {
            font-family: var(--font-tech);
            background: #333;
            border: 1px solid #555;
            color: #ccc;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .back-button:hover { background-color: var(--amber); color: #000; }

        .command-bar {
            background-color: #000; padding: 8px 12px;
            font-size: 0.9rem; margin-bottom: 15px; border: 1px solid #222;
        }
        .command-bar span { color: var(--neon-green); }

        .footer-log {
            margin-top: auto; padding-top: 10px;
            border-top: 1px solid var(--panel-border);
            font-family: var(--font-pixel); font-size: 1.5rem;
            text-align: center; color: var(--amber); height: 50px;
        }
        .footer-log .subtext { font-size: 1.2rem; color: #ccc; letter-spacing: 4px; }
        
        .main-content { flex-grow: 1; display: grid; gap: 15px; overflow: hidden; }

        /* --- SHARED UI COMPONENTS --- */
        .knob-group { display: flex; justify-content: space-around; padding: 10px 0; }
        .knob { text-align: center; }
        .knob .dial {
            width: 50px; height: 50px; background-color: #333; border: 2px solid #222;
            border-radius: 50%; position: relative; margin: 0 auto 5px;
            cursor: ns-resize;
        }
        .knob .dial::after {
            content: ''; position: absolute; width: 2px; height: 12px;
            background-color: var(--text-color); top: 6px; left: 50%;
            transform: translateX(-50%);
        }
        .knob label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        .toggle-switch { text-align: center; }
        .toggle-switch .switch-body {
            width: 50px; height: 25px; background-color: #222;
            border-radius: 15px; position: relative; margin: 0 auto 5px;
            border: 1px solid #444; cursor: pointer;
        }
        .toggle-switch .flick {
            width: 19px; height: 19px; background-color: #e0e0e0; border-radius: 50%;
            position: absolute; top: 2px; transition: all 0.2s ease;
        }
        .toggle-switch .flick.on { left: 27px; background-color: var(--neon-green); }
        .toggle-switch .flick.off { left: 4px; }
        .toggle-switch label { font-size: 0.8rem; text-transform: uppercase; }

        /* --- RADAR DISPLAY & BLIPS --- */
        .radar-display {
            background-color: var(--screen-bg); border: 1px solid #333; position: relative;
            border-radius: 50%; overflow: hidden;
            background-image:
                radial-gradient(circle, transparent 32.8%, var(--grid-color) 33%, transparent 33.2%),
                radial-gradient(circle, transparent 65.8%, var(--grid-color) 66%, transparent 66.2%),
                repeating-conic-gradient(from 0deg, var(--grid-color) 0deg 0.5deg, transparent 0.5deg 45deg);
        }
        .blip {
            position: absolute; width: 10px; height: 10px;
            background-color: var(--neon-green); border-radius: 50%;
            box-shadow: 0 0 10px 3px var(--neon-green-glow);
            transition: all 0.2s;
        }
        .blip.selected {
            background-color: var(--amber);
            box-shadow: 0 0 12px 4px var(--amber-glow);
            transform: scale(1.5);
        }
        .blip.fused {
            background-color: #f0f;
            box-shadow: 0 0 15px 5px #f0f;
        }

        /* === PANEL 1: ECHO SCAN CONTROL === */
        #panel-echo-scan .main-content { grid-template-columns: 1fr 250px; }
        #panel-echo-scan .sweep-line {
            position: absolute; width: 2px; height: 50%;
            background: linear-gradient(to top, var(--neon-green-glow), transparent);
            top: 0; left: 50%;
            transform-origin: bottom center;
        }
        #panel-echo-scan .control-panel { display: flex; flex-direction: column; justify-content: space-around; }
        #panel-echo-scan .led-group { display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--panel-border); border-bottom: 1px solid var(--panel-border); }
        #panel-echo-scan .led-indicator { text-align: center; }
        #panel-echo-scan .led { width: 12px; height: 12px; background-color: #333; border-radius: 50%; margin: 0 auto 5px; border: 1px solid #222; transition: background-color 0.2s; }
        #panel-echo-scan .led.active { background-color: var(--neon-green); }
        #panel-echo-scan .led.locked { animation: blink 1s infinite; }

        /* === PANEL 2: FIELD INTERCEPT MODE === */
        #panel-field-intercept .main-content { grid-template-columns: 1fr 250px; }
        #panel-field-intercept .radar-map {
            position: relative; background-color: var(--screen-bg); border: 1px solid #333;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 29px, var(--grid-color) 30px),
                repeating-linear-gradient(90deg, transparent, transparent 29px, var(--grid-color) 30px);
            background-size: 30px 30px;
            cursor: grab;
        }
        #panel-field-intercept .radar-map:active { cursor: grabbing; }
        #panel-field-intercept .blip { cursor: inherit; background-color: var(--amber); box-shadow: 0 0 10px 3px var(--amber-glow); }
        #panel-field-intercept .control-panel { display: flex; flex-direction: column; justify-content: space-between; }
        #panel-field-intercept .gauge {
            position: relative; width: 100%; aspect-ratio: 2/1;
            overflow: hidden; text-align: center;
        }
        #panel-field-intercept .gauge::before {
            content: ''; position: absolute; top: 0; left: 0; width: 200%; height: 200%;
            background-color: #222; border: 20px solid #333;
            border-bottom-color: var(--neon-green); border-radius: 50%; transform: translateX(-25%);
        }
        #panel-field-intercept .gauge .needle {
            position: absolute; width: 2px; height: 90%; background-color: var(--amber);
            bottom: -40%; left: 50%; transform-origin: bottom center;
            transition: transform 0.3s ease-out;
            transform: rotate(-80deg); /* Start position */
        }
        #panel-field-intercept .gauge label { position: absolute; bottom: 5px; width: 100%; left: 0; font-size: 0.8rem; text-transform: uppercase; }
        
        #panel-field-intercept .button-row { display: grid; grid-template-columns: 1fr; gap: 10px; }
        #panel-field-intercept .te-button {
            background-color: #2a2a2a; border: 1px solid #444; padding: 10px;
            text-align: center; font-size: 0.9rem; text-transform: uppercase;
            box-shadow: 0 0 5px 1px #000 inset; cursor: pointer; transition: all 0.2s;
        }
        #panel-field-intercept .te-button:hover { background-color: #3f3f3f; }
        #panel-field-intercept .te-button.active {
            color: var(--neon-green); background-color: #333;
            box-shadow: 0 0 8px 2px var(--neon-green-glow) inset;
        }
        #panel-field-intercept .te-button:disabled {
            background-color: #222; color: #555; cursor: not-allowed; box-shadow: none;
        }

        /* === PANEL 3: SYNTHESIS RANGE MODE === */
        #panel-synthesis-range .main-content { grid-template-columns: 45% 55%; }
        #panel-synthesis-range .radar-display {
            background-image:
                radial-gradient(circle, var(--grid-color) 1px, transparent 1px),
                radial-gradient(circle, var(--amber, 0.3) 60%, transparent 60.5%);
            background-size: 20px 20px, 100% 100%;
        }
        #panel-synthesis-range .blip { cursor: pointer; }
        #panel-synthesis-range .codon-viz { display: flex; gap: 1px; padding: 2px; background-color: #333; border: 1px solid #555; }
        #panel-synthesis-range .codon-viz span { width: 4px; height: 12px; }
        .c1 { background-color: #4CAF50; } .c2 { background-color: #F44336; }
        .c3 { background-color: #2196F3; } .c4 { background-color: #FFC107; }

        #panel-synthesis-range .synthesis-table table { width: 100%; border-collapse: collapse; font-size: 0.9rem;}
        #panel-synthesis-range .synthesis-table th, #panel-synthesis-range .synthesis-table td { border: 1px solid var(--panel-border); padding: 5px 8px; text-align: center; height: 40px; }
        #panel-synthesis-range .synthesis-table th { color: var(--amber); }
        #panel-synthesis-range .fused-row {
            background-color: rgba(79, 244, 79, 0.1);
            box-shadow: 0 0 10px 2px rgba(79, 244, 79, 0.2) inset;
            color: var(--neon-green); font-weight: bold;
        }
        #panel-synthesis-range .dial-container { text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="crt-overlay"></div>

    <div id="boot-screen">
        <h1>FUSE RADAR OS</h1>
        <p>SELECT INTERFACE TO LOAD</p>
        <div class="boot-options">
            <button data-panel="panel-echo-scan">ECHO SCAN</button>
            <button data-panel="panel-field-intercept">FIELD INTERCEPT</button>
            <button data-panel="panel-synthesis-range">SYNTHESIS RANGE</button>
        </div>
    </div>

    <!-- PANEL 1: ECHO SCAN CONTROL -->
    <div class="panel-container" id="panel-echo-scan">
        <div class="panel-header">
            <div class="panel-title">ECHO SCAN CONTROL</div>
            <button class="back-button">SYSTEM MENU</button>
        </div>
        <div class="command-bar">> fuse <span class="genome1-id">...</span>+<span class="genome2-id">...</span> using:<span>radar-scan</span></div>
        <div class="main-content">
            <div class="radar-display">
                <div class="sweep-line"></div>
                <div class="blips-container"></div>
            </div>
            <div class="control-panel">
                <div class="knob-group">
                    <div class="knob" data-control="scanSpeed" title="Drag Up/Down"><div class="dial"></div><label>SCAN SPEED</label></div>
                    <div class="knob" data-control="sensitivity" title="Drag Up/Down"><div class="dial"></div><label>SENSITIVITY</label></div>
                </div>
                <div class="toggle-group">
                    <div class="toggle-switch" data-control="lockOn"><div class="switch-body"><div class="flick off"></div></div><label>LOCK-ON</label></div>
                    <div class="toggle-switch" data-control="autoMerge"><div class="switch-body"><div class="flick off"></div></div><label>AUTO-MERGE</label></div>
                </div>
                <div class="led-group">
                    <div class="led-indicator"><div class="led" id="led-blip1"></div><label>BLIP 1</label></div>
                    <div class="led-indicator"><div class="led" id="led-blip2"></div><label>BLIP 2</label></div>
                    <div class="led-indicator"><div class="led" id="led-locked"></div><label>LOCKED</label></div>
                </div>
            </div>
        </div>
        <div class="footer-log">Awaiting signal lock...</div>
    </div>

    <!-- PANEL 2: FIELD INTERCEPT MODE -->
    <div class="panel-container" id="panel-field-intercept">
        <div class="panel-header">
            <div class="panel-title">FIELD INTERCEPT MODE</div>
            <button class="back-button">SYSTEM MENU</button>
        </div>
        <div class="command-bar">> fuse <span class="genome1-id">...</span>+<span class="genome2-id">...</span> using:<span>radar-intercept</span></div>
        <div class="main-content">
            <div class="radar-map">
                <div class="blips-container"></div>
            </div>
            <div class="control-panel">
                <div class="gauge-group">
                    <div class="gauge">
                        <div class="needle"></div>
                        <label>MERGE-POTENTIAL</label>
                    </div>
                </div>
                <div class="button-row">
                    <button class="te-button" data-control="ping">PING FIELD</button>
                    <button class="te-button" data-control="reset">RESET POSITIONS</button>
                    <button class="te-button" data-control="capture" disabled>CAPTURE FUSE</button>
                </div>
            </div>
        </div>
        <div class="footer-log">Drag genomes to intercept.</div>
    </div>

    <!-- PANEL 3: SYNTHESIS RANGE MODE -->
    <div class="panel-container" id="panel-synthesis-range">
        <div class="panel-header">
            <div class="panel-title">SYNTHESIS RANGE MODE</div>
            <button class="back-button">SYSTEM MENU</button>
        </div>
        <div class="main-content">
            <div class="radar-display">
                <div class="blips-container"></div>
            </div>
            <div class="synthesis-table">
                <table>
                    <thead>
                        <tr><th>ID</th><th>CODON SPECTRA</th><th>Î¼-RATE</th></tr>
                    </thead>
                    <tbody>
                        <tr class="genome-row-1"><td>-</td><td>-</td><td>-</td></tr>
                        <tr class="genome-row-2"><td>-</td><td>-</td><td>-</td></tr>
                        <tr class="fused-row"><td>-</td><td>-</td><td>-</td></tr>
                    </tbody>
                </table>
                <div class="dial-container">
                    <div class="knob" data-control="mergeIntensity" title="Drag Up/Down to set Merge Intensity">
                        <div class="dial"></div>
                        <label>MERGE INTENSITY</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-log">Select two genomes to begin synthesis.</div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- GENERIC GENOME FACTORY ---
    const createGenome = (id, container, type = 'default') => {
        const size = container.offsetWidth;
        const radius = 0.15 * size + Math.random() * (0.3 * size);
        const angle = Math.random() * 2 * Math.PI;
        const genome = {
            id: `g-${String(id).padStart(3, '0')}`,
            el: document.createElement('div'),
            x: size / 2 + radius * Math.cos(angle),
            y: size / 2 + radius * Math.sin(angle),
            angle: angle,
            radius: radius,
            vx: (Math.random() - 0.5) * 2,
            vy: (Math.random() - 0.5) * 2,
            codonSpectra: [Math.random(), Math.random(), Math.random(), Math.random()],
            mutationRate: Math.random() * 0.5,
        };
        genome.el.className = 'blip';
        genome.el.dataset.id = genome.id;
        container.appendChild(genome.el);
        return genome;
    };

    const App = {
        panels: {},
        activePanel: null,
        init() {
            document.querySelectorAll('.boot-options button').forEach(btn => {
                btn.addEventListener('click', () => this.launchPanel(btn.dataset.panel));
            });
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', () => this.showBootScreen());
            });
        },
        launchPanel(panelId) {
            if (this.activePanel) this.panels[this.activePanel].shutdown();
            
            document.getElementById('boot-screen').style.display = 'none';
            Object.values(this.panels).forEach(p => p.container.style.display = 'none');
            
            this.activePanel = panelId;
            this.panels[panelId].container.style.display = 'flex';
            this.panels[panelId].init();
        },
        showBootScreen() {
            if (this.activePanel) this.panels[this.activePanel].shutdown();
            Object.values(this.panels).forEach(p => p.container.style.display = 'none');
            document.getElementById('boot-screen').style.display = 'block';
            this.activePanel = null;
        }
    };
    
    // --- PANEL 1: ECHO SCAN ---
    App.panels['panel-echo-scan'] = {
        container: document.getElementById('panel-echo-scan'),
        state: {
            genomes: [],
            scanSpeed: 5, // in seconds
            sensitivity: 0.1, // in radians
            lockOn: false,
            autoMerge: false,
            locked: [],
            sweepAngle: 0,
            animationFrame: null
        },
        
        init() {
            this.blipsContainer = this.container.querySelector('.blips-container');
            this.footer = this.container.querySelector('.footer-log');
            this.sweepLine = this.container.querySelector('.sweep-line');
            
            this.reset();
            this.setupControls();
            this.gameLoop();
        },

        reset() {
            this.state.locked = [];
            this.state.genomes = [];
            this.blipsContainer.innerHTML = '';
            for (let i = 0; i < 15; i++) {
                this.state.genomes.push(createGenome(i, this.container.querySelector('.radar-display')));
            }
            this.updateDisplay();
        },

        setupControls() {
            // This is a simplified setup. A real one would add many listeners.
            this.container.querySelector('[data-control="lockOn"]').onclick = (e) => {
                this.state.lockOn = !this.state.lockOn;
                e.currentTarget.querySelector('.flick').classList.toggle('on', this.state.lockOn);
                e.currentTarget.querySelector('.flick').classList.toggle('off', !this.state.lockOn);
                if (!this.state.lockOn) {
                    this.state.locked = []; // Clear locks when disabled
                    this.updateDisplay();
                }
            };
            this.container.querySelector('[data-control="autoMerge"]').onclick = (e) => {
                this.state.autoMerge = !this.state.autoMerge;
                e.currentTarget.querySelector('.flick').classList.toggle('on', this.state.autoMerge);
                e.currentTarget.querySelector('.flick').classList.toggle('off', !this.state.autoMerge);
            };
            // Simplified knob controls for demo
            this.sweepLine.style.animation = `sweep ${this.state.scanSpeed}s linear infinite`;
        },

        gameLoop() {
            const now = performance.now();
            this.state.sweepAngle = ((now / (this.state.scanSpeed * 1000)) % 1) * 2 * Math.PI;

            if (this.state.lockOn && this.state.locked.length < 2) {
                this.state.genomes.forEach(g => {
                    if (this.state.locked.includes(g)) return;
                    const angleDiff = Math.abs(this.state.sweepAngle - g.angle);
                    if (Math.min(angleDiff, 2 * Math.PI - angleDiff) < this.state.sensitivity) {
                        this.state.locked.push(g);
                        this.updateDisplay();
                    }
                });
            }

            if (this.state.autoMerge && this.state.locked.length === 2) {
                this.fuseGenomes();
            }

            this.state.animationFrame = requestAnimationFrame(() => this.gameLoop());
        },

        fuseGenomes() {
            const [g1, g2] = this.state.locked;
            this.footer.textContent = `FUSION CONFIRMED: ${g1.id} + ${g2.id}`;
            this.footer.innerHTML += `<div class="subtext">GENERATING g-fused-1</div>`;
            g1.el.classList.add('fused');
            g2.el.classList.add('fused');
            this.state.lockOn = false; // Stop scanning post-fusion
            this.container.querySelector('[data-control="lockOn"] .flick').classList.remove('on');
            this.container.querySelector('[data-control="lockOn"] .flick').classList.add('off');
        },

        updateDisplay() {
            this.state.genomes.forEach(g => {
                g.el.style.transform = `translate(${g.x - 5}px, ${g.y - 5}px)`;
                g.el.classList.toggle('selected', this.state.locked.includes(g));
            });
            this.container.querySelector('#led-blip1').classList.toggle('active', this.state.locked.length >= 1);
            this.container.querySelector('#led-blip2').classList.toggle('active', this.state.locked.length >= 2);
            this.container.querySelector('#led-locked').classList.toggle('locked', this.state.locked.length >= 2);
            
            this.container.querySelector('.genome1-id').textContent = this.state.locked[0]?.id || '...';
            this.container.querySelector('.genome2-id').textContent = this.state.locked[1]?.id || '...';
        },
        
        shutdown() {
            cancelAnimationFrame(this.state.animationFrame);
        }
    };

    // --- PANEL 2: FIELD INTERCEPT ---
    App.panels['panel-field-intercept'] = {
        container: document.getElementById('panel-field-intercept'),
        state: { genomes: [], animationFrame: null, selectedGenome: null, mergePotential: 0 },
        
        init() {
            this.map = this.container.querySelector('.radar-map');
            this.blipsContainer = this.container.querySelector('.blips-container');
            this.needle = this.container.querySelector('.needle');
            this.captureButton = this.container.querySelector('[data-control="capture"]');
            
            this.reset();
            this.setupControls();
            this.gameLoop();
        },
        
        reset() {
            this.blipsContainer.innerHTML = '';
            this.state.genomes = [];
            for (let i = 0; i < 8; i++) {
                const g = createGenome(100+i, this.map);
                g.x = Math.random() * this.map.offsetWidth;
                g.y = Math.random() * this.map.offsetHeight;
                this.state.genomes.push(g);
            }
            this.updateDisplay();
        },
        
        setupControls() {
            this.container.querySelector('[data-control="reset"]').onclick = () => this.reset();
            this.captureButton.onclick = () => this.captureFuse();
            
            // Drag and drop logic
            this.map.onmousedown = (e) => {
                if (!e.target.classList.contains('blip')) return;
                this.state.selectedGenome = this.state.genomes.find(g => g.el === e.target);
                if (this.state.selectedGenome) {
                    this.map.onmousemove = (move_e) => {
                        if (!this.state.selectedGenome) return;
                        const rect = this.map.getBoundingClientRect();
                        this.state.selectedGenome.x = move_e.clientX - rect.left;
                        this.state.selectedGenome.y = move_e.clientY - rect.top;
                    };
                    this.map.onmouseup = this.map.onmouseleave = () => {
                        this.state.selectedGenome = null;
                        this.map.onmousemove = null;
                    };
                }
            };
        },
        
        gameLoop() {
            if (!this.state.selectedGenome) { // Move blips if not being dragged
                this.state.genomes.forEach(g => {
                    g.x += g.vx; g.y += g.vy;
                    if (g.x <= 0 || g.x >= this.map.offsetWidth) g.vx *= -1;
                    if (g.y <= 0 || g.y >= this.map.offsetHeight) g.vy *= -1;
                });
            }
            this.checkProximity();
            this.updateDisplay();
            this.state.animationFrame = requestAnimationFrame(() => this.gameLoop());
        },

        checkProximity() {
            let potential = 0;
            this.state.closePair = null;
            for(let i=0; i<this.state.genomes.length; i++) {
                for (let j=i+1; j<this.state.genomes.length; j++) {
                    const g1 = this.state.genomes[i];
                    const g2 = this.state.genomes[j];
                    const dist = Math.hypot(g1.x - g2.x, g1.y - g2.y);
                    if (dist < 50) {
                        potential = Math.max(potential, 1 - (dist / 50));
                        if (potential > 0.8) this.state.closePair = [g1, g2];
                    }
                }
            }
            this.state.mergePotential = potential;
        },

        captureFuse() {
            if (!this.state.closePair) return;
            const [g1, g2] = this.state.closePair;
            this.state.genomes = this.state.genomes.filter(g => g !== g1 && g !== g2);
            g1.el.remove();
            g2.el.remove();
            
            const newG = createGenome(200, this.map);
            newG.x = (g1.x + g2.x) / 2;
            newG.y = (g1.y + g2.y) / 2;
            newG.el.classList.add('fused');
            this.state.genomes.push(newG);
            
            this.container.querySelector('.footer-log').textContent = `FUSED: ${g1.id} + ${g2.id}`;
        },
        
        updateDisplay() {
            this.state.genomes.forEach(g => {
                g.el.style.transform = `translate(${g.x - 5}px, ${g.y - 5}px)`;
            });
            const angle = -80 + (this.state.mergePotential * 160);
            this.needle.style.transform = `rotate(${angle}deg)`;

            if (this.state.closePair) {
                this.captureButton.disabled = false;
                this.captureButton.classList.add('active');
                this.container.querySelector('.genome1-id').textContent = this.state.closePair[0].id;
                this.container.querySelector('.genome2-id').textContent = this.state.closePair[1].id;
            } else {
                this.captureButton.disabled = true;
                this.captureButton.classList.remove('active');
                this.container.querySelector('.genome1-id').textContent = '...';
                this.container.querySelector('.genome2-id').textContent = '...';
            }
        },
        
        shutdown() {
            cancelAnimationFrame(this.state.animationFrame);
        }
    };
    
    // --- PANEL 3: SYNTHESIS RANGE ---
    App.panels['panel-synthesis-range'] = {
        container: document.getElementById('panel-synthesis-range'),
        state: { genomes: [], selected: [], intensity: 0.5 },

        init() {
            this.blipsContainer = this.container.querySelector('.blips-container');
            this.reset();
            this.setupControls();
        },

        reset() {
            this.state.selected = [];
            this.blipsContainer.innerHTML = '';
            this.state.genomes = [];
            for (let i = 0; i < 10; i++) {
                const g = createGenome(300+i, this.container.querySelector('.radar-display'));
                const viz = document.createElement('div');
                viz.className = 'codon-viz';
                viz.innerHTML = g.codonSpectra.map((_, i) => `<span class="c${i+1}"></span>`).join('');
                g.el.appendChild(viz);
                this.state.genomes.push(g);
                g.el.onclick = () => this.selectGenome(g);
            }
            this.updateDisplay();
        },
        
        setupControls() {
            const dial = this.container.querySelector('[data-control="mergeIntensity"] .dial');
            let isDragging = false;
            dial.onmousedown = () => { isDragging = true; };
            document.onmouseup = () => { isDragging = false; };
            document.onmousemove = (e) => {
                if (isDragging) {
                    this.state.intensity -= e.movementY * 0.005;
                    this.state.intensity = Math.max(0, Math.min(1, this.state.intensity));
                    this.updateDisplay();
                }
            };
        },

        selectGenome(genome) {
            if (this.state.selected.includes(genome)) return;
            if (this.state.selected.length >= 2) this.state.selected.shift();
            this.state.selected.push(genome);
            this.updateDisplay();
        },

        updateDisplay() {
            // Update blip visuals
            this.state.genomes.forEach(g => {
                g.el.style.transform = `translate(${g.x - g.el.offsetWidth/2}px, ${g.y - g.el.offsetHeight/2}px)`;
                g.el.classList.toggle('selected', this.state.selected.includes(g));
            });

            // Update table
            const rows = this.container.querySelectorAll('.synthesis-table tbody tr');
            const g1 = this.state.selected[0];
            const g2 = this.state.selected[1];

            this.updateTableRow(rows[0], g1);
            this.updateTableRow(rows[1], g2);

            // Update fused row
            if (g1 && g2) {
                const fusedSpectra = g1.codonSpectra.map((c, i) => (c * (1 - this.state.intensity)) + (g2.codonSpectra[i] * this.state.intensity));
                const fusedMutation = (g1.mutationRate * (1 - this.state.intensity)) + (g2.mutationRate * this.state.intensity);
                rows[2].cells[0].textContent = 'g-syn-01';
                rows[2].cells[1].innerHTML = `<div class="codon-viz" style="margin: auto;">
                    <span class="c1" style="opacity:${fusedSpectra[0]}"></span>
                    <span class="c2" style="opacity:${fusedSpectra[1]}"></span>
                    <span class="c3" style="opacity:${fusedSpectra[2]}"></span>
                    <span class="c4" style="opacity:${fusedSpectra[3]}"></span>
                </div>`;
                rows[2].cells[2].textContent = fusedMutation.toFixed(2) + '%';
            } else {
                this.updateTableRow(rows[2], null);
            }

            // Update dial rotation
            const dial = this.container.querySelector('[data-control="mergeIntensity"] .dial');
            dial.style.transform = `rotate(${this.state.intensity * 270 - 135}deg)`;
        },

        updateTableRow(row, genome) {
            if (genome) {
                row.cells[0].textContent = genome.id;
                row.cells[1].innerHTML = `<div class="codon-viz" style="margin: auto;">
                    ${genome.codonSpectra.map((c,i) => `<span class="c${i+1}"></span>`).join('')}
                </div>`;
                row.cells[2].textContent = genome.mutationRate.toFixed(2) + '%';
            } else {
                row.cells[0].textContent = '-';
                row.cells[1].textContent = '-';
                row.cells[2].textContent = '-';
            }
        },
        
        shutdown() { /* No animation frame to cancel, just state reset */ }
    };

    // --- INITIALIZE THE APP ---
    App.init();
});
</script>
</body>
</html>