<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CodonSynth - Evolutionary Music Ecology</title>
    <style>
        :root {
            --background-color: #f0f0e0;
            --main-color: #1a1a1a;
            --border-color: #1a1a1a;
            --highlight-color: #4a90e2;
            --font-family: 'Courier New', Courier, monospace;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--main-color);
            margin: 0;
            padding: 1em;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 1em;
            width: 100%;
            max-width: 800px;
            border: 2px solid var(--border-color);
            padding: 1em;
            background-color: #e8e8d8;
        }

        .module {
            border: 1px solid var(--border-color);
            padding: 1em;
            display: flex;
            flex-direction: column;
        }

        .module h3 {
            margin: 0 0 0.25em 0;
            font-size: 1.1em;
            text-transform: uppercase;
        }
        
        .module .subtitle {
            font-size: 0.8em;
            margin-bottom: 1em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .controls-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 1em;
        }

        .dial-group {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .dial {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            position: relative;
            background: #f0f0e0;
            cursor: pointer;
        }

        .dial-indicator {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: center;
            transition: transform 0.05s linear;
        }
        
        .dial-indicator::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 15px;
            background: var(--main-color);
        }
        
        .dial-label {
            font-size: 0.7em;
            text-align: center;
            margin-top: 0.5em;
        }

        .button-group button {
            font-family: var(--font-family);
            background: var(--background-color);
            border: 1px solid var(--border-color);
            padding: 0.5em 1em;
            text-transform: uppercase;
            cursor: pointer;
        }
        
        .patchboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5em;
            border: 1px solid var(--border-color);
            padding: 0.5em;
            height: 100px;
        }

        .patch-point {
            border: 1px solid var(--border-color);
            font-size: 0.7em;
            text-align: center;
            padding: 0.5em 0;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        .patch-point.active {
            background-color: var(--highlight-color);
            color: var(--background-color);
        }

        .step-sequencer ol {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step-sequencer li {
            padding: 0.25em;
            border-bottom: 1px dashed var(--border-color);
        }

        #gene-pool-matrix {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 10px;
            background: #111;
            border-radius: 4px;
            min-height: 100px;
            align-content: flex-start;
            margin-top: 10px;
        }

        .gene-tile {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background-color: #0f0;
            transition: opacity 0.5s ease, background-color 0.5s ease, border 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .gene-tile.frozen {
            border-color: #fff;
            box-shadow: 0 0 5px #fff;
        }

        .status-display {
            border: 1px solid var(--border-color);
            padding: 1em;
            text-align: center;
            font-size: 0.9em;
            background: #fafad2; /* LightGoldenRodYellow */
        }

        @media (max-width: 600px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>

    <div class="main-container">
        <!-- 1. COMPLIANCE TRACKER -> GENE POOL & MUTATION LOG -->
        <div id="gene-pool-container" class="module">
            <h3>FUSE: GENE POOL</h3>
            <div class="subtitle">fuse log:gen-17 + mutation-rate-alpha</div>
            <div class="controls-area">
                <div class="dial-group">
                    <div><div class="dial" id="intron-dial"><div class="dial-indicator"></div></div><div class="dial-label">INTRON</div></div>
                    <div><div class="dial" id="exon-dial"><div class="dial-indicator"></div></div><div class="dial-label">EXON</div></div>
                    <div><div class="dial" id="codon-dial"><div class="dial-indicator"></div></div><div class="dial-label">CODON</div></div>
                </div>
                <div class="status-display" id="gene-pool-status">INITIATING...</div>
                <div id="gene-pool-matrix"></div>
            </div>
        </div>

        <!-- 2. REGULATORY PATCHBOARD -> FITNESS ENVIRONMENT TUNER -->
        <div id="fitness-tuner-container" class="module">
            <h3>FUSE: FITNESS ENV</h3>
            <div class="subtitle" id="fitness-env-subtitle">fuse base-ecology</div>
            <div class="controls-area">
                <div style="display:flex; flex-direction: column; gap:1em;">
                    <div style="display:flex; gap:1em;">
                        <div class="patchboard">
                            <div class="patch-point" id="harmony-patch">HARMONY</div>
                            <div class="patch-point" id="rhythm-patch">RHYTHM</div>
                            <div class="patch-point" id="timbre-patch">TIMBRE</div>
                            <div class="patch-point">MOTIF</div>
                        </div>
                        <div class="dial-group" style="flex-direction:column; justify-content:space-between;">
                            <div><div class="dial" id="bias-dial"><div class="dial-indicator"></div></div><div class="dial-label">BIAS</div></div>
                            <div><div class="dial" id="drift-dial"><div class="dial-indicator"></div></div><div class="dial-label">DRIFT</div></div>
                        </div>
                    </div>
                    <div class="status-display" id="harmony-status">MAJOR</div>
                    <div class="status-display" id="timbre-status">SINE</div>
                    <div class="status-display" id="tonal-center-status">C4</div>
                </div>
            </div>
        </div>

        <!-- 3. SOP CONTROL PANEL -> ECOSYSTEM & EPOCH MANAGER -->
        <div id="ecosystem-manager-container" class="module">
            <h3>FUSE: ECOSYSTEM SOP</h3>
            <div class="subtitle">fuse g-seed-01 + g-seed-02 via SOP-mode</div>
            <div class="controls-area step-sequencer">
                <ol>
                    <li>1. INITIATE</li>
                    <li>2. VALIDATE</li>
                    <li>3. MERGE</li>
                    <li>4. ARCHIVE</li>
                </ol>
            </div>
        </div>

        <!-- 4. WORKFLOW MODULE -> SYSTEM MONITOR -->
        <div id="system-monitor-container" class="module">
            <h3>FUSE: SYSTEM MONITOR</h3>
            <div class="subtitle">fuse: MergePolicy-17 to g-merged-026</div>
            <div class="controls-area">
                <div>Codon Count: <span id="codon-count">0</span></div>
                <div class="status-display" id="system-status">SUCCESS - 0 genes thriving</div>
                <div class="button-group">
                    <button id="exec-button">EXEC</button>
                </div>
            </div>
        </div>

        <!-- 5. FITNESS RADAR -->
        <div id="fitness-radar-container" class="module" style="grid-column: 1 / -1;">
            <h3>FUSE: FITNESS RADAR</h3>
            <div class="subtitle">fuse: real-time ecology vector</div>
            <div class="controls-area" style="align-items: center;">
                <canvas id="fitness-radar-canvas" width="300" height="200"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        // --- CodonSynth Core Logic --- //
        document.addEventListener('DOMContentLoaded', () => {
            console.log('CodonSynth Initialized. Tone.js loaded.');

            // --- DOM Elements ---
            const mainContainer = document.querySelector('.main-container');
            const genePoolStatus = document.getElementById('gene-pool-status');
            const codonCountEl = document.getElementById('codon-count');
            const systemStatus = document.getElementById('system-status');
            const execButton = document.getElementById('exec-button');
            const harmonyPatch = document.getElementById('harmony-patch');
            const rhythmPatch = document.getElementById('rhythm-patch');
            const harmonyStatus = document.getElementById('harmony-status');
            const timbreStatus = document.getElementById('timbre-status');
            const tonalCenterStatus = document.getElementById('tonal-center-status');
            const genePoolMatrix = document.getElementById('gene-pool-matrix');
            const radarCanvas = document.getElementById('fitness-radar-canvas');

            // --- Audio Engine Setup ---
            const synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.2 },
            }).toDestination();
            synth.volume.value = -12;

            // --- Genetic & Evolutionary Parameters ---
            let genePool = [];
            let generation = 0;
            const PITCH_SET = ['C4', 'Db4', 'D4', 'Eb4', 'E4', 'F4', 'Gb4', 'G4', 'Ab4', 'A4', 'Bb4', 'B4', 'C5'];
            const SCALES = {
                'MAJOR': ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'],
                'MINOR': ['C4', 'D4', 'Eb4', 'F4', 'G4', 'Ab4', 'Bb4', 'C5'],
                'DORIAN': ['C4', 'D4', 'Eb4', 'F4', 'G4', 'A4', 'Bb4', 'C5'],
                'BLUES': ['C4', 'Eb4', 'F4', 'Gb4', 'G4', 'Bb4', 'C5'],
            };
            let scaleKeys = Object.keys(SCALES);

            const fitnessEnvironment = {
                harmonyBias: 0.7,
                tonalGravity: 0.2,
                survivalThreshold: 0.5,
                mutationRate: 0.1,
                activeScale: 'MAJOR',
                TONAL_CENTER: 'C4',
                rhythmCohesionActive: false,
                maxPopulation: 50
            };

            // --- Codon Class: The Musical Gene ---
            class Codon {
                constructor(pitch, rhythm, parentId = null) {
                    this.id = `g-${generation}-${Math.random().toString(16).slice(2, 8)}`;
                    this.pitch = pitch || PITCH_SET[Math.floor(Math.random() * PITCH_SET.length)];
                    this.rhythm = rhythm || ['8n', '16n'][Math.floor(Math.random() * 2)];
                    this.health = 1.0;
                    this.parentId = parentId;
                    this.frozen = false;
                }

                play(time) {
                    if (this.health > 0.2) {
                        synth.triggerAttackRelease(this.pitch, this.rhythm, time, this.health);
                    }
                }

                evaluateFitness(currentGenePool) {
                    const scaleNotes = SCALES[fitnessEnvironment.activeScale];
                    const isScaleNote = scaleNotes.some(note => this.pitch.startsWith(note.slice(0, -1)));

                    // Tonal Gravity: closer to the tonal center is fitter
                    const tonalCenterMidi = Tone.Frequency(fitnessEnvironment.TONAL_CENTER).toMidi();
                    const pitchMidi = Tone.Frequency(this.pitch).toMidi();
                    const distance = Math.abs(tonalCenterMidi - pitchMidi) % 12;
                    const gravityBonus = (12 - distance) / 12 * fitnessEnvironment.tonalGravity;

                    const harmonyBonus = isScaleNote ? fitnessEnvironment.harmonyBias : 0;

                    // Rhythm Cohesion
                    let rhythmBonus = 0;
                    if (fitnessEnvironment.rhythmCohesionActive && currentGenePool.length > 0) {
                        const rhythmCounts = currentGenePool.reduce((acc, codon) => {
                            acc[codon.rhythm] = (acc[codon.rhythm] || 0) + 1;
                            return acc;
                        }, {});
                        const dominantRhythm = Object.keys(rhythmCounts).reduce((a, b) => rhythmCounts[a] > rhythmCounts[b] ? a : b);
                        if (this.rhythm === dominantRhythm) {
                            rhythmBonus = 0.2; // Cohesion bonus
                        }
                    }

                    this.health = Math.max(0, Math.min(1, 0.3 + harmonyBonus + gravityBonus + rhythmBonus));
                }

                replicate() {
                    let childPitch = this.pitch;
                    if (Math.random() < fitnessEnvironment.mutationRate) {
                        childPitch = PITCH_SET[Math.floor(Math.random() * PITCH_SET.length)];
                    }
                    return new Codon(childPitch, this.rhythm, this.id);
                }
            }

            // --- Core Evolutionary Loop ---
            function evolutionaryLoop() {
                const nextGeneration = [];
                const currentPool = [...genePool]; // Use a snapshot for evaluation

                currentPool.forEach(codon => {
                    codon.evaluateFitness(currentPool);

                    if (codon.frozen) {
                        nextGeneration.push(codon);
                    } else if (codon.health > fitnessEnvironment.survivalThreshold) {
                        nextGeneration.push(codon);
                        if (nextGeneration.length < fitnessEnvironment.maxPopulation) {
                            nextGeneration.push(codon.replicate());
                        }
                    }
                });
                genePool = nextGeneration;
                generation++;
                updateUI();
            }

            // --- UI & Transport ---
            function updateUI() {
                codonCountEl.textContent = genePool.length;
                genePoolStatus.textContent = `GENERATION ${generation}`;
                const thrivingCount = genePool.filter(c => c.health > fitnessEnvironment.survivalThreshold).length;
                systemStatus.textContent = `SUCCESS - ${thrivingCount} genes thriving`;
                if (radarCanvas) drawRadarChart();

                genePoolMatrix.innerHTML = '';
                genePool.forEach(codon => {
                    const tile = document.createElement('div');
                    tile.className = 'gene-tile';
                    tile.dataset.id = codon.id; // Add ID for click tracking
                    if (codon.frozen) {
                        tile.classList.add('frozen');
                    }

                    const hue = codon.health * 120;
                    tile.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
                    tile.style.opacity = Math.max(0.2, codon.health);
                    genePoolMatrix.appendChild(tile);
                });
            }

            function updateDialVisual(dialId, value, min = 0, max = 1) {
                const dialElement = document.getElementById(dialId);
                if (!dialElement) return;
                const dialIndicator = dialElement.querySelector('.dial-indicator');
                if (!dialIndicator) return;

                const percentage = (value - min) / (max - min);
                const rotation = -135 + (percentage * 270);
                dialIndicator.style.transform = `rotate(${rotation}deg)`;
            }

            function drawRadarChart() {
                const ctx = radarCanvas.getContext('2d');
                const style = getComputedStyle(document.documentElement);
                const mainColor = style.getPropertyValue('--main-color').trim();
                const highlightColor = style.getPropertyValue('--highlight-color').trim();
                const fontFamily = style.getPropertyValue('--font-family').trim();
                
                const width = radarCanvas.width;
                const height = radarCanvas.height;
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(height / 2 * 0.7, width / 2 * 0.7);

                ctx.clearRect(0, 0, width, height);
                ctx.strokeStyle = mainColor;
                ctx.fillStyle = mainColor;
                ctx.font = `10px ${fontFamily}`;

                const labels = ['HARMONY', 'GRAVITY', 'SURVIVAL', 'STABILITY'];
                const numAxes = labels.length;

                // Draw axes and labels
                for (let i = 0; i < numAxes; i++) {
                    const angle = (i * Math.PI * 2 / numAxes) - (Math.PI / 2);
                    const labelAngle = (i * Math.PI * 2 / numAxes) - (Math.PI / 2);
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.lineTo(centerX + radius * Math.cos(angle), centerY + radius * Math.sin(angle));
                    ctx.stroke();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(labels[i], centerX + (radius + 15) * Math.cos(labelAngle), centerY + (radius + 15) * Math.sin(labelAngle));
                }

                // Plot data
                const values = [
                    fitnessEnvironment.harmonyBias,
                    fitnessEnvironment.tonalGravity,
                    fitnessEnvironment.survivalThreshold,
                    1 - fitnessEnvironment.mutationRate
                ];

                ctx.beginPath();
                ctx.fillStyle = 'rgba(74, 144, 226, 0.4)';
                ctx.strokeStyle = highlightColor;
                ctx.lineWidth = 2;

                values.forEach((value, i) => {
                    const v = Math.max(0, Math.min(1, value));
                    const angle = (i * Math.PI * 2 / numAxes) - (Math.PI / 2);
                    const x = centerX + radius * v * Math.cos(angle);
                    const y = centerY + radius * v * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            function makeDialInteractive(dialId, parameterObject, parameterKey, min = 0, max = 1) {
                const dialElement = document.getElementById(dialId);
                let isDragging = false;
                let startY = 0;
                let startValue = 0;

                const onInteractionStart = (e) => {
                    isDragging = true;
                    startY = e.clientY || e.touches[0].clientY;
                    startValue = parameterObject[parameterKey];
                    document.body.style.cursor = 'ns-resize';
                    dialElement.style.cursor = 'ns-resize';
                };

                const onInteractionMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const currentY = e.clientY || e.touches[0].clientY;
                    const deltaY = startY - currentY;
                    const change = (deltaY / 200) * (max - min);
                    let newValue = startValue + change;
                    newValue = Math.max(min, Math.min(max, newValue));

                    parameterObject[parameterKey] = newValue;
                    updateDialVisual(dialId, newValue, min, max);
                };

                const onInteractionEnd = () => {
                    isDragging = false;
                    document.body.style.cursor = 'default';
                    dialElement.style.cursor = 'pointer';
                };

                dialElement.addEventListener('mousedown', onInteractionStart);
                dialElement.addEventListener('touchstart', onInteractionStart, { passive: false });
                document.addEventListener('mousemove', onInteractionMove);
                document.addEventListener('touchmove', onInteractionMove, { passive: false });
                document.addEventListener('mouseup', onInteractionEnd);
                document.addEventListener('touchend', onInteractionEnd);

                updateDialVisual(dialId, parameterObject[parameterKey], min, max);
            }

            function scheduleGenePool(time) {
                genePool.forEach(codon => {
                    if (Math.random() > 0.5) {
                        codon.play(time);
                    }
                });
            }

            function init() {
                genePool = [];
                generation = 0;
                for (let i = 0; i < 10; i++) {
                    genePool.push(new Codon());
                }
                updateUI();
                if (Tone.Transport.state !== 'started') {
                    Tone.Transport.scheduleRepeat(scheduleGenePool, '4n');
                    Tone.Transport.scheduleRepeat(evolutionaryLoop, '1m');
                }
            }

            // --- App Start & Main Controls ---
            execButton.addEventListener('click', async () => {
                await Tone.start();
                if (Tone.Transport.state === 'started') {
                    Tone.Transport.stop();
                    execButton.textContent = 'EXEC';
                } else {
                    init();
                    Tone.Transport.start();
                    execButton.textContent = 'HALT';
                }
            });

harmonyPatch.addEventListener('click', () => {
    const currentIndex = scaleKeys.indexOf(fitnessEnvironment.activeScale);
    const nextIndex = (currentIndex + 1) % scaleKeys.length;
    fitnessEnvironment.activeScale = scaleKeys[nextIndex];
    harmonyStatus.textContent = fitnessEnvironment.activeScale;
    console.log(`Scale changed to ${fitnessEnvironment.activeScale}`);
});

rhythmPatch.addEventListener('click', () => {
    fitnessEnvironment.rhythmCohesionActive = !fitnessEnvironment.rhythmCohesionActive;
    rhythmPatch.classList.toggle('active', fitnessEnvironment.rhythmCohesionActive);
    console.log(`Rhythm Cohesion: ${fitnessEnvironment.rhythmCohesionActive}`);
});

// --- Gestural Controls ---
const OSCILLATOR_TYPES = ['sine', 'triangle', 'sawtooth', 'square'];
let activeOscillatorIndex = 0;
            let initialAngle = 0;

            function getDistance(touches) {
                const [touch1, touch2] = touches;
                return Math.hypot(touch1.pageX - touch2.pageX, touch1.pageY - touch2.pageY);
            }

            function getAngle(touches) {
                const [touch1, touch2] = touches;
                return Math.atan2(touch2.pageY - touch1.pageY, touch2.pageX - touch1.pageX);
            }

            mainContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialPinchDistance = getDistance(e.touches);
                    startMutationRate = fitnessEnvironment.mutationRate;
                    initialAngle = getAngle(e.touches);
                } else if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }
            }, { passive: false });

            mainContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && initialPinchDistance) {
                    e.preventDefault();
                    // Pinch to zoom for mutation rate
                    const currentDistance = getDistance(e.touches);
                    const scale = currentDistance / initialPinchDistance;
                    const newMutationRate = Math.min(1, Math.max(0, startMutationRate * (1 / scale)));
                    fitnessEnvironment.mutationRate = newMutationRate;
                    updateDialVisual('intron-dial', newMutationRate);

                    // Rotate for tonal center
                    const currentAngle = getAngle(e.touches);
                    const angleDiff = currentAngle - initialAngle;

                    if (Math.abs(angleDiff) > Math.PI / 6) { // ~30 degrees threshold
                        const scaleNotes = SCALES[fitnessEnvironment.activeScale];
                        const currentTonicIndex = scaleNotes.findIndex(note => note.startsWith(fitnessEnvironment.TONAL_CENTER.slice(0, -1)));
                        let nextTonicIndex = currentTonicIndex;
                        if (angleDiff > 0) { // Clockwise
                            nextTonicIndex = (currentTonicIndex + 1) % scaleNotes.length;
                        } else { // Counter-clockwise
                            nextTonicIndex = (currentTonicIndex - 1 + scaleNotes.length) % scaleNotes.length;
                        }
                        fitnessEnvironment.TONAL_CENTER = scaleNotes[nextTonicIndex];
                        tonalCenterStatus.textContent = fitnessEnvironment.TONAL_CENTER;
                        console.log(`Tonic shifted to ${fitnessEnvironment.TONAL_CENTER}`);
                        initialAngle = currentAngle; // Reset angle to prevent rapid shifts
                    }
                }
            }, { passive: false });

            mainContainer.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) {
                    initialPinchDistance = null;
                }
                if (e.touches.length < 1) {
                    touchStartX = 0;
                    touchStartY = 0;
                }
            });

            genePoolMatrix.addEventListener('click', (e) => {
                if (e.target.classList.contains('gene-tile')) {
                    const codonId = e.target.dataset.id;
                    const targetCodon = genePool.find(c => c.id === codonId);
                    if (targetCodon) {
                        targetCodon.frozen = !targetCodon.frozen;
                        updateUI(); // Re-render immediately to show frozen status
                    }
                }
            });

            mainContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1 && touchStartX !== 0) {
                    const touchEndX = e.touches[0].clientX;
                    const deltaX = touchEndX - touchStartX;

                    if (Math.abs(deltaX) > 50) { // Swipe threshold
                        if (deltaX > 0) { // Swipe Right
                            activeOscillatorIndex = (activeOscillatorIndex + 1) % OSCILLATOR_TYPES.length;
                        } else { // Swipe Left
                            activeOscillatorIndex = (activeOscillatorIndex - 1 + OSCILLATOR_TYPES.length) % OSCILLATOR_TYPES.length;
                        }
                        const newType = OSCILLATOR_TYPES[activeOscillatorIndex];
                        synth.set({ oscillator: { type: newType } });
                        timbreStatus.textContent = newType.toUpperCase();
                        console.log(`Switched to ${newType} oscillator.`);
                        touchStartX = 0; // Reset after swipe
                    }
                }
            });

            // --- Initial UI Setup ---
            makeDialInteractive('bias-dial', fitnessEnvironment, 'harmonyBias');
            makeDialInteractive('intron-dial', fitnessEnvironment, 'mutationRate');
            makeDialInteractive('drift-dial', fitnessEnvironment, 'survivalThreshold');
            makeDialInteractive('exon-dial', fitnessEnvironment, 'tonalGravity');
            makeDialInteractive('codon-dial', fitnessEnvironment, 'maxPopulation', 10, 100);

            updateDialVisual('bias-dial', fitnessEnvironment.harmonyBias);
            updateDialVisual('intron-dial', fitnessEnvironment.mutationRate);
            updateDialVisual('drift-dial', fitnessEnvironment.survivalThreshold);
            updateDialVisual('exon-dial', fitnessEnvironment.tonalGravity);
            updateDialVisual('codon-dial', fitnessEnvironment.maxPopulation, 10, 100);
            
            harmonyStatus.textContent = fitnessEnvironment.activeScale;
            timbreStatus.textContent = OSCILLATOR_TYPES[activeOscillatorIndex].toUpperCase();
            tonalCenterStatus.textContent = fitnessEnvironment.TONAL_CENTER;
            if (radarCanvas) drawRadarChart();

        });
    </script>

</body>
</html>