<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPERCLAY // STACK v20</title>
    
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23ff9d5c' d='M50 0 L93.3 25 V75 L50 100 L6.7 75 V25 Z'/%3E%3C/svg%3E">

    <style>
        :root {
            /* --- THEME: EXCAVATION (High Contrast Dark) --- */
            --bg-void: #050505;
            --bg-panel: #14100f;
            --bg-hover: #261f1d;
            
            --text-primary: #ffcdb2;
            --text-secondary: #b0988e;
            --text-muted: #6b554e;
            
            --border: #4a3832;
            --accent: #ff9d5c;
            --accent-glow: rgba(255, 157, 92, 0.2);
            
            /* CATEGORY COLORS */
            --class-core: #ffaa75;   /* Orange/Peach */
            --class-media: #75b3ff;  /* Blue */
            --class-tool: #75ffaa;   /* Green */
            --class-exp: #e075ff;    /* Purple */
            
            --header-height: 52px;
            --row-height: 64px;
            --sidebar-width: 48px;
            
            /* Animation Physics */
            --ease-mech: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-snap: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        [data-theme="light"] {
            --bg-void: #ffffff;
            --bg-panel: #f0f0f0;
            --bg-hover: #e6e6e6;
            
            --text-primary: #000000;
            --text-secondary: #4a4a4a;
            --text-muted: #888888;
            
            --border: #cccccc;
            --accent: #d13d00;
            --accent-glow: rgba(209, 61, 0, 0.1);

            --class-core: #d13d00;
            --class-media: #0044cc;
            --class-tool: #007733;
            --class-exp: #770099;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg-void);
            font-family: 'Courier New', monospace;
            height: 100%; width: 100%;
            overflow: hidden;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- LAYOUT --- */
        #sequencer-ui { display: flex; flex-direction: column; height: 100%; width: 100%; }

        /* --- HEADER --- */
        #global-hud {
            height: var(--header-height);
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; z-index: 100; flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .hud-left { display: flex; align-items: center; gap: 15px; }

        .hud-logo {
            width: 26px; height: 26px;
            color: var(--accent);
            cursor: pointer;
            transition: transform 0.3s var(--ease-snap);
        }
        .hud-logo:hover { transform: rotate(90deg); filter: drop-shadow(0 0 4px var(--accent)); }

        .hud-controls { display: flex; gap: 12px; }

        .btn-icon {
            background: transparent; border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; cursor: pointer; border-radius: 4px;
            transition: all 0.2s;
        }
        .btn-icon:hover {
            border-color: var(--text-primary); color: var(--text-primary);
            background: var(--bg-hover);
        }
        .btn-icon.active { background: var(--text-secondary); color: var(--bg-void); }

        /* --- WORKSPACE --- */
        #workspace { display: flex; flex-grow: 1; overflow: hidden; position: relative; }

        /* --- LEFT RAIL (PROGRESS) --- */
        .dna-rail {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center;
            padding-top: 10px; z-index: 10;
            position: relative;
        }
        
        .rail-track {
            position: absolute; top: 0; bottom: 0; width: 2px; background: var(--border);
            z-index: 0;
        }
        .rail-progress {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 4px; background: var(--accent);
            height: 0%; 
            z-index: 1; transition: height 0.1s linear;
        }

        .rail-mark { 
            width: 12px; height: 1px; background: var(--text-muted); 
            margin: 0; position: absolute; left: 50%; transform: translateX(-50%);
        }

        /* --- SCROLL AREA --- */
        #genome-scroll {
            flex-grow: 1; overflow-y: scroll; scroll-behavior: auto;
            scrollbar-width: none; -ms-overflow-style: none;
            position: relative;
        }
        #genome-scroll::-webkit-scrollbar { display: none; }

        /* --- GENE LIST (LIST vs GRID) --- */
        #gene-list {
            display: flex; flex-direction: column;
            width: 100%;
        }

        /* GRID MODE STYLES */
        #gene-list.grid-mode {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            padding: 16px;
            align-items: start;
        }

        /* --- GENE ROW (Base) --- */
        .gene-row {
            background: var(--bg-void);
            border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column;
            transition: background 0.3s, transform 0.3s, border-color 0.3s;
            overflow: hidden;
        }

        /* GRID ITEM overrides */
        #gene-list.grid-mode .gene-row {
            border: 1px solid var(--border);
            height: 140px; /* Square Cells */
            border-radius: 4px;
            position: relative;
        }
        /* Expanded in Grid Mode (Full Width Injection) */
        #gene-list.grid-mode .gene-row.active {
            grid-column: 1 / -1; /* Span all columns */
            height: auto;
            border-color: var(--accent);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        /* --- GENE HEADER --- */
        .gene-header {
            height: var(--row-height);
            display: flex; align-items: center;
            padding: 0 16px; cursor: pointer;
            position: relative; flex-shrink: 0;
            overflow: hidden;
            user-select: none;
            background: var(--bg-void);
            z-index: 2;
        }
        .gene-header:hover { background: var(--bg-hover); }

        /* Grid Mode Header Tweaks */
        #gene-list.grid-mode .gene-row:not(.active) .gene-header {
            height: 100%; flex-direction: column; 
            align-items: flex-start; justify-content: space-between;
            padding: 12px;
        }
        #gene-list.grid-mode .gene-row:not(.active) .id-cluster {
            width: 100%; border-right: none; height: auto; margin-bottom: 10px;
        }
        #gene-list.grid-mode .gene-row:not(.active) .gene-controls { display: none; }
        #gene-list.grid-mode .gene-row:not(.active) .gene-info { width: 100%; }
        #gene-list.grid-mode .gene-row:not(.active) .gene-barcode { height: 8px; }

        /* ID Cluster */
        .id-cluster {
            display: flex; align-items: center; height: 100%;
            width: 70px; flex-shrink: 0;
            border-right: 1px solid var(--border);
            margin-right: 16px;
        }
        .class-indicator { width: 4px; height: 100%; margin-right: 8px; background: var(--text-muted); }
        .gene-barcode { flex-grow: 1; height: 24px; opacity: 0.7; }

        /* Info Block */
        .gene-info {
            display: flex; flex-direction: column; justify-content: center;
            align-items: flex-start; 
            flex-grow: 1; overflow: hidden;
        }
        .gene-title {
            font-size: 0.95rem; font-weight: 800; letter-spacing: 0.5px;
            text-transform: uppercase; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            width: 100%;
        }
        .gene-desc {
            font-size: 0.7rem; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            width: 100%; margin-top: 4px;
        }

        /* Controls */
        .gene-controls { margin-left: 10px; display: flex; align-items: center; gap: 12px; }
        
        .ext-link {
            text-decoration: none; color: var(--text-secondary);
            padding: 8px; border-radius: 4px;
            transition: all 0.2s;
        }
        .ext-link:hover { color: var(--text-primary); background: var(--bg-hover); }

        .arrow-indicator {
            font-size: 0.8rem; color: var(--text-secondary);
            transition: transform 0.4s var(--ease-snap);
        }

        /* --- ACTIVE STATE --- */
        .gene-row.active { background: var(--bg-hover); border-bottom-color: var(--accent); }
        .gene-row.active .class-indicator { box-shadow: 0 0 8px currentColor; }
        .gene-row.active .gene-barcode { opacity: 1; filter: contrast(1.2); }
        .gene-row.active .arrow-indicator { transform: rotate(90deg); color: var(--accent); }

        /* --- EXPRESSION WINDOW (ANIMATION ROOT) --- */
        .expression-window {
            height: 0; overflow: hidden;
            /* Improved Kinetic Physics */
            transition: height 0.6s var(--ease-mech);
            background: #000; position: relative;
            transform-origin: top;
            will-change: height;
        }
        .gene-row.active .expression-window { height: 60vh; }

        .signal-loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-muted); font-size: 0.8rem; letter-spacing: 2px;
            animation: pulse 1.5s infinite; pointer-events: none; z-index: 0;
        }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        iframe {
            width: 100%; height: 100%; border: none;
            position: relative; z-index: 1;
            opacity: 0; transition: opacity 0.5s ease-in 0.2s; /* Delay fade in */
        }
        .gene-row.active iframe.loaded { opacity: 1; }

        /* --- RIGHT RAIL (MINIMAP & LENS) --- */
        #minimap-rail {
            width: 24px; background: var(--bg-panel);
            border-left: 1px solid var(--border); position: relative;
            cursor: pointer; touch-action: none;
        }
        
        .map-indicator {
            width: 100%; position: absolute; left: 0; opacity: 0.4;
            height: 2px; transition: all 0.2s; pointer-events: none;
        }
        .map-indicator.active {
            opacity: 1; height: 4px; width: 100%; 
            box-shadow: -2px 0 5px currentColor; z-index: 2;
        }

        #minimap-lens {
            position: absolute; left: 0; right: 0;
            height: 0; top: 0;
            border: 2px solid var(--accent);
            background: var(--accent-glow);
            z-index: 10; border-radius: 2px;
            cursor: grab;
            transition: top 0.1s linear, height 0.1s linear, background-color 0.2s;
        }
        #minimap-lens:active { cursor: grabbing; background: var(--accent); opacity: 0.5; }

        /* --- MODAL --- */
        #about-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 999; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #about-modal.visible { opacity: 1; pointer-events: all; }
        
        .modal-box {
            background: var(--bg-void); border: 1px solid var(--text-primary);
            padding: 30px; max-width: 400px; width: 85%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .modal-header { 
            border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px;
            font-weight: bold; color: var(--text-primary); letter-spacing: 2px; font-size: 1.1rem;
        }
        .btn-text {
            background: var(--bg-panel); border: 1px solid var(--border);
            color: var(--text-primary); padding: 12px; width: 100%;
            cursor: pointer; font-family: inherit; font-weight: bold; font-size: 0.9rem;
            margin-top: 24px; text-transform: uppercase;
        }
        .btn-text:hover { background: var(--bg-hover); border-color: var(--accent); }

    </style>
</head>
<body>

<!-- ABOUT MODAL -->
<div id="about-modal">
    <div class="modal-box">
        <div class="modal-header">SYSTEM_MANIFEST // v20.0</div>
        <p style="font-size:0.9rem; color:var(--text-secondary); line-height:1.6;">
            <strong>HYPERCLAY STACK</strong><br>
            20 unique sonic modules generated for procedural composition.<br><br>
            <strong>MODES:</strong><br>
            • LIST: Linear sequence traversal.<br>
            • GRID: Matrix density visualization.<br><br>
            <strong>LEGEND:</strong><br>
            <span style="color:var(--class-core)">■ CORE</span> Foundation<br>
            <span style="color:var(--class-media)">■ MEDIA</span> Texture/Filter<br>
            <span style="color:var(--class-tool)">■ TOOL</span> Logic/Control<br>
            <span style="color:var(--class-exp)">■ EXP</span> Experimental
        </p>
        <button class="btn-text" onclick="toggleAbout()">INITIALIZE</button>
    </div>
</div>

<div id="sequencer-ui">
    
    <!-- HEADER -->
    <header id="global-hud">
        <div class="hud-left">
            <svg class="hud-logo" onclick="toggleAbout()" viewBox="0 0 100 100">
                <path d="M50 10 L90 30 V70 L50 90 L10 70 V30 Z" fill="none" stroke="currentColor" stroke-width="4"/>
                <circle cx="50" cy="50" r="12" fill="currentColor"/>
                <path d="M50 10 V38 M50 90 V62 M10 30 L38 44 M90 30 L62 44 M10 70 L38 56 M90 70 L62 56" stroke="currentColor" stroke-width="2"/>
            </svg>
        </div>

        <div class="hud-controls">
            <!-- Grid/List Toggle -->
            <button class="btn-icon" onclick="toggleGrid()" id="view-toggle" title="Toggle Grid/List View">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="Toggle Theme">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            </button>
            <button class="btn-icon" onclick="toggleAll()" id="expand-btn" title="Expand All">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 12h8"/><path d="M12 8v8" id="expand-icon-path"/></svg>
            </button>
        </div>
    </header>

    <div id="workspace">
        <!-- LEFT RAIL (PROGRESS) -->
        <div class="dna-rail">
            <div class="rail-track"></div>
            <div class="rail-progress" id="rail-progress"></div>
            <!-- Marks injected via JS -->
        </div>

        <!-- MAIN SCROLL -->
        <main id="genome-scroll">
            <div id="gene-list"></div>
            <div style="height: 100px;"></div>
        </main>

        <!-- RIGHT RAIL (MINIMAP) -->
        <div id="minimap-rail">
            <div id="minimap-lens"></div>
            <!-- Map injected via JS -->
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const BASE_URL = "https://hartswf0.github.io/hyperclay-editor/";
    
    // --- 20 MODULES ---
    const DATA = [
        { file: "son-mod-01.html", desc: "Initial Sine Driver", class: "core" },
        { file: "son-mod-02.html", desc: "Phase Shift Array", class: "media" },
        { file: "son-mod-03.html", desc: "Thermal Noise Floor", class: "exp" },
        { file: "son-mod-04.html", desc: "Control Voltage Matrix", class: "tool" },
        { file: "son-mod-05.html", desc: "Subharmonic Generator", class: "core" },
        { file: "son-mod-06.html", desc: "Granular Bed Layer", class: "media" },
        { file: "son-mod-07.html", desc: "Spectral Distortion", class: "exp" },
        { file: "son-mod-08.html", desc: "Bitcrush Logic", class: "tool" },
        { file: "son-mod-09.html", desc: "Wavefolder Circuit", class: "media" },
        { file: "son-mod-10.html", desc: "Envelope Follower", class: "core" },
        { file: "son-mod-11.html", desc: "LFO Cluster A", class: "tool" },
        { file: "son-mod-12.html", desc: "Comb Resonator", class: "media" },
        { file: "son-mod-13.html", desc: "Probability Gate", class: "exp" },
        { file: "son-mod-14.html", desc: "Sequencer Grid Alpha", class: "core" },
        { file: "son-mod-15.html", desc: "Sequencer Grid Beta", class: "core" },
        { file: "son-mod-16.html", desc: "Spring Reverb Tank", class: "media" },
        { file: "son-mod-17.html", desc: "Bucket Brigade Delay", class: "media" },
        { file: "son-mod-18.html", desc: "Output Bus Compressor", class: "tool" },
        { file: "son-mod-19.html", desc: "Master Gain Stage", class: "core" },
        { file: "son-mod-20.html", desc: "System Log / Diagnostics", class: "exp" }
    ];

    const listContainer = document.getElementById('gene-list');
    const mapRail = document.getElementById('minimap-rail');
    const leftRail = document.querySelector('.dna-rail');
    const scrollContainer = document.getElementById('genome-scroll');
    const lens = document.getElementById('minimap-lens');
    const progressBar = document.getElementById('rail-progress');
    
    let allExpanded = false;
    let isDragging = false;
    let gridMode = false;

    // --- HELPER: Generate Barcode ---
    function generateBarcode(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        let gradient = "linear-gradient(90deg, ";
        for (let i = 0; i <= 100; i+=10) {
            const val = Math.abs((hash * (i+1)) % 100);
            const opacity = val > 50 ? 1 : 0; 
            gradient += `currentColor ${i}%, transparent ${i}%, transparent ${i+5}%, currentColor ${i+5}%, `; 
        }
        return gradient.slice(0, -2) + ")"; 
    }

    // --- INIT ---
    function init() {
        const markCount = DATA.length;
        for(let i=0; i<markCount; i++) {
            const mark = document.createElement('div');
            mark.className = 'rail-mark';
            mark.style.top = `${(i / markCount) * 100}%`;
            leftRail.appendChild(mark);
        }

        DATA.forEach((item, index) => {
            createGene(item, index);
        });
        
        setTimeout(updateLens, 100);
    }

    function createGene(item, index) {
        // Pretty formatting for title
        const title = item.file.replace('.html', '').toUpperCase();
        const url = BASE_URL + item.file;
        const barcodeStyle = generateBarcode(item.file);
        const colorVar = `var(--class-${item.class})`;

        const row = document.createElement('div');
        row.className = 'gene-row';
        row.id = `gene-${index}`;

        row.innerHTML = `
            <div class="gene-header" onclick="toggleGene(${index})" role="button" aria-label="Toggle ${title}">
                <div class="id-cluster">
                    <div class="class-indicator" style="background:${colorVar}; box-shadow:0 0 5px ${colorVar};"></div>
                    <div class="gene-barcode" style="background-image:${barcodeStyle}; color:${colorVar}"></div>
                </div>
                <div class="gene-info">
                    <span class="gene-title">${title}</span>
                    <span class="gene-desc">${item.desc}</span>
                </div>
                <div class="gene-controls">
                    <a href="${url}" target="_blank" class="ext-link" onclick="stopProp(event)" title="Open in New Tab">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>
                    <div class="arrow-indicator">▶</div>
                </div>
            </div>
            <div class="expression-window">
                <div class="signal-loader">ACQUIRING SIGNAL...</div>
                <iframe id="iframe-${index}" data-src="${url}" onload="this.classList.add('loaded')" title="${title}"></iframe>
            </div>
        `;
        listContainer.appendChild(row);

        const dot = document.createElement('div');
        dot.className = 'map-indicator';
        dot.style.top = `${(index / DATA.length) * 100}%`;
        dot.style.height = `${100 / DATA.length}%`;
        dot.style.backgroundColor = colorVar; 
        dot.id = `map-${index}`;
        mapRail.appendChild(dot);
    }

    // --- LOGIC ---
    window.toggleGene = (index) => {
        const row = document.getElementById(`gene-${index}`);
        const isActive = row.classList.contains('active');
        
        isActive ? closeGene(index) : openGene(index);
        checkAllState();
        setTimeout(updateLens, 450);
    };

    function openGene(index) {
        const row = document.getElementById(`gene-${index}`);
        const iframe = document.getElementById(`iframe-${index}`);
        const mapDot = document.getElementById(`map-${index}`);

        row.classList.add('active');
        mapDot.classList.add('active');
        
        if (gridMode) {
            setTimeout(() => {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        if (!iframe.getAttribute('src')) {
            iframe.src = iframe.dataset.src;
        }
    }

    function closeGene(index) {
        const row = document.getElementById(`gene-${index}`);
        const iframe = document.getElementById(`iframe-${index}`);
        const mapDot = document.getElementById(`map-${index}`);

        row.classList.remove('active');
        mapDot.classList.remove('active');

        setTimeout(() => {
            if(!row.classList.contains('active')) {
                iframe.removeAttribute('src'); 
                iframe.classList.remove('loaded');
            }
        }, 600); // Matches CSS transition time
    }

    // Staggered Expansion
    window.toggleAll = () => {
        allExpanded = !allExpanded;
        const iconPath = document.getElementById('expand-icon-path');
        iconPath.setAttribute('d', allExpanded ? "M6 12h12" : "M12 8v8"); 
        
        const btn = document.getElementById('expand-btn');
        btn.classList.toggle('active', allExpanded);

        DATA.forEach((_, index) => {
            if(allExpanded) {
                // Quick Cascade
                setTimeout(() => openGene(index), index * 30); 
            } else {
                // Faster collapse
                setTimeout(() => closeGene(index), index * 10);
            }
        });
        
        setTimeout(updateLens, (DATA.length * 30) + 600);
    };

    function checkAllState() {
        const activeCount = document.querySelectorAll('.gene-row.active').length;
        if (activeCount === 0) {
            allExpanded = false;
            document.getElementById('expand-btn').classList.remove('active');
            document.getElementById('expand-icon-path').setAttribute('d', "M12 8v8");
        }
    }

    window.toggleGrid = () => {
        gridMode = !gridMode;
        listContainer.classList.toggle('grid-mode', gridMode);
        document.getElementById('view-toggle').classList.toggle('active', gridMode);
        setTimeout(updateLens, 300);
    };

    window.stopProp = (e) => e.stopPropagation();

    window.toggleTheme = () => {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        body.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
    };

    window.toggleAbout = () => {
        document.getElementById('about-modal').classList.toggle('visible');
    };

    // --- LENS & SCROLL LOGIC ---
    function updateLens() {
        if (!scrollContainer) return;
        const scrollTop = scrollContainer.scrollTop;
        const scrollHeight = scrollContainer.scrollHeight;
        const clientHeight = scrollContainer.clientHeight;
        
        if (scrollHeight === 0) return;

        const lensHeightPerc = (clientHeight / scrollHeight) * 100;
        const lensTopPerc = (scrollTop / scrollHeight) * 100;
        
        lens.style.height = `${lensHeightPerc}%`;
        lens.style.top = `${lensTopPerc}%`;

        const progressPerc = (scrollTop / (scrollHeight - clientHeight)) * 100;
        progressBar.style.height = `${Math.min(100, Math.max(0, progressPerc))}%`;
    }

    scrollContainer.addEventListener('scroll', () => {
        if (!isDragging) requestAnimationFrame(updateLens);
    });

    // --- RAIL INTERACTION ---
    mapRail.addEventListener('pointerdown', (e) => {
        isDragging = true;
        mapRail.setPointerCapture(e.pointerId);
        handleRailInput(e, 'smooth');
    });

    mapRail.addEventListener('pointermove', (e) => {
        if (!isDragging) return;
        handleRailInput(e, 'auto');
    });

    mapRail.addEventListener('pointerup', (e) => {
        isDragging = false;
        mapRail.releasePointerCapture(e.pointerId);
    });

    function handleRailInput(e, behavior) {
        const rect = mapRail.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const perc = Math.max(0, Math.min(1, y / rect.height));
        const targetScroll = perc * (scrollContainer.scrollHeight - scrollContainer.clientHeight);
        scrollContainer.scrollTo({ top: targetScroll, behavior: behavior });
    }

    init();

</script>
</body>
</html>
