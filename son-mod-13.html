<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HYPERCLAY // STRATA</title>
<style>
    :root {
        /* EARTH PALETTE */
        --void: #1a1918;      /* Deep Loam */
        --surface: #262422;   /* Dark Earth */
        --border: #3d3a36;    /* Stone */
        
        --sand: #e6dcc8;      /* Text / Highlight */
        --clay: #c26a4b;      /* Active / Warm */
        --moss: #6b7d5d;      /* Passive / Cool */
        --slate: #707b85;     /* Structural */
        
        --strip-h: 100px;     /* Height of one instrument layer */
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    
    body {
        margin: 0; background: var(--void); color: var(--sand);
        font-family: 'Courier New', monospace; overflow: hidden;
        height: 100vh; display: flex; flex-direction: column;
    }

    /* --- GLOBAL HEADER --- */
    header {
        height: 44px; border-bottom: 1px solid var(--border);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 16px; background: var(--surface); z-index: 100;
    }
    .brand { font-weight: bold; letter-spacing: 2px; font-size: 14px; color: var(--clay); }
    .transport { display: flex; gap: 16px; align-items: center; }
    .btn { 
        cursor: pointer; font-size: 12px; border: 1px solid var(--border); 
        padding: 4px 12px; border-radius: 2px; transition: all 0.2s;
        color: var(--slate);
    }
    .btn.active { background: var(--sand); color: var(--void); border-color: var(--sand); }

    /* --- THE STRATA (SCROLLABLE AREA) --- */
    #strata {
        flex: 1; overflow-y: auto; overflow-x: hidden;
        display: flex; flex-direction: column;
        padding-bottom: 50px; /* Space for thumb */
    }

    /* --- SINGLE INSTRUMENT STRIP --- */
    .layer {
        height: var(--strip-h);
        width: 100%;
        display: grid;
        grid-template-columns: 60px 1fr 120px; /* Label | Mesh | Params */
        border-bottom: 1px solid var(--border);
        position: relative;
        background: var(--surface);
        transition: background 0.2s;
    }
    
    /* LEFT: META */
    .layer-meta {
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        border-right: 1px solid var(--border);
        font-size: 10px; color: var(--slate); letter-spacing: 1px;
        cursor: pointer;
    }
    .layer-id { font-size: 16px; font-weight: bold; color: var(--sand); margin-bottom: 4px; }
    .layer.muted .layer-id { color: var(--border); text-decoration: line-through; }

    /* CENTER: THE CLAY MESH */
    .layer-canvas {
        position: relative; overflow: hidden; cursor: crosshair;
        background: #1e1c1b;
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* RIGHT: PARAM SLIDERS */
    .layer-params {
        display: flex; flex-direction: column; 
        border-left: 1px solid var(--border);
    }
    .param-strip {
        flex: 1; display: flex; align-items: center; padding: 0 8px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        font-size: 9px; color: var(--slate); position: relative;
    }
    .param-strip:last-child { border-bottom: none; }
    .param-label { width: 30px; z-index: 2; pointer-events: none; }
    .param-bar {
        position: absolute; left: 0; top: 0; bottom: 0;
        background: rgba(255,255,255,0.03); width: 0%;
        transition: width 0.1s; pointer-events: none;
    }
    .param-touch {
        position: absolute; inset: 0; cursor: ew-resize; z-index: 1;
    }

    /* PLAYHEAD (Global overlay) */
    .playhead-line {
        position: absolute; top: 0; bottom: 0; width: 1px;
        background: rgba(230, 220, 200, 0.2);
        pointer-events: none; z-index: 50;
    }

</style>
</head>
<body>

<header>
    <div class="brand">STRATA // ENGINE</div>
    <div class="transport">
        <div class="btn" id="btn-reset">CLR</div>
        <div class="btn" id="btn-play">PLAY</div>
    </div>
</header>

<div id="strata">
    <!-- LAYERS GENERATED JS -->
</div>

<script>
/**
 * HYPERCLAY STRATA
 * A unified "Earth" aesthetic control surface.
 */

// --- GLOBAL AUDIO BUS ---
const AudioEngine = {
    ctx: null,
    master: null,
    compressor: null,
    tempo: 100,
    isPlaying: false,
    startTime: 0,
    
    init() {
        if(this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Master Bus Processing (glue)
        this.compressor = this.ctx.createDynamicsCompressor();
        this.compressor.threshold.value = -20;
        this.compressor.ratio.value = 4;
        
        this.master = this.ctx.createGain();
        this.master.gain.value = 0.8;
        
        this.compressor.connect(this.master);
        this.master.connect(this.ctx.destination);
    },

    toggle() {
        if(!this.ctx) this.init();
        if(this.ctx.state === 'suspended') this.ctx.resume();
        this.isPlaying = !this.isPlaying;
        return this.isPlaying;
    }
};

// --- DATA MODEL ---
const LAYERS = [
    { id: '01', type: 'KICK', color: '#8c8c88', note: 50 }, // Slate
    { id: '02', type: 'SNARE', color: '#a69e8f', note: 200 }, // Light Stone
    { id: '03', type: 'HIHAT', color: '#c4bfa8', note: 800 }, // Sand
    { id: '04', type: 'BASS', color: '#4a5d43', note: 55 },  // Moss
    { id: '05', type: 'SUB', color: '#2f3b2b', note: 40 },   // Deep Moss
    { id: '06', type: 'LEAD', color: '#c26a4b', note: 440 }, // Clay
    { id: '07', type: 'CHORD', color: '#d98e73', note: 330 } // Terra
];

// --- CLASS: SINGLE STRATA LAYER ---
class StrataLayer {
    constructor(config, container) {
        this.cfg = config;
        this.params = { vol: 0.8, decay: 0.5 };
        this.points = [];
        this.muted = false;
        
        // Create DOM
        this.el = document.createElement('div');
        this.el.className = 'layer';
        this.el.innerHTML = `
            <div class="layer-meta">
                <div class="layer-id">${config.id}</div>
                <div>${config.type}</div>
            </div>
            <div class="layer-canvas">
                <canvas></canvas>
            </div>
            <div class="layer-params">
                <div class="param-strip">
                    <div class="param-bar" style="width: 80%"></div>
                    <span class="param-label">VOL</span>
                    <div class="param-touch" data-p="vol"></div>
                </div>
                <div class="param-strip">
                    <div class="param-bar" style="width: 50%"></div>
                    <span class="param-label">DEC</span>
                    <div class="param-touch" data-p="decay"></div>
                </div>
            </div>
        `;
        container.appendChild(this.el);

        // Canvas Setup
        this.cv = this.el.querySelector('canvas');
        this.ctx = this.cv.getContext('2d');
        
        // Event Listeners
        this.bindEvents();
        this.resize();
        this.initMesh();
    }

    bindEvents() {
        // Mute
        this.el.querySelector('.layer-meta').addEventListener('click', () => {
            this.muted = !this.muted;
            this.el.classList.toggle('muted', this.muted);
        });

        // Params
        const touches = this.el.querySelectorAll('.param-touch');
        touches.forEach(t => {
            const handle = (e) => {
                const rect = t.getBoundingClientRect();
                const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                const p = t.dataset.p;
                this.params[p] = pct;
                t.parentElement.querySelector('.param-bar').style.width = `${pct * 100}%`;
            };
            t.addEventListener('pointerdown', (e) => {
                t.setPointerCapture(e.pointerId);
                handle(e);
                t.onpointermove = handle;
                t.onpointerup = () => t.onpointermove = null;
            });
        });

        // Mesh Interaction (Sculpting)
        let isDrag = false;
        this.cv.addEventListener('pointerdown', e => {
            isDrag = true;
            this.sculpt(e.offsetX, e.offsetY);
            this.cv.setPointerCapture(e.pointerId);
        });
        this.cv.addEventListener('pointermove', e => {
            if(isDrag) this.sculpt(e.offsetX, e.offsetY);
        });
        this.cv.addEventListener('pointerup', () => isDrag = false);
    }

    resize() {
        const rect = this.cv.parentElement.getBoundingClientRect();
        this.w = rect.width;
        this.h = rect.height;
        this.cv.width = this.w;
        this.cv.height = this.h;
        this.initMesh();
    }

    initMesh() {
        this.points = [];
        const count = 32; // 32 steps
        for(let i=0; i<count; i++) {
            const x = (i / (count-1)) * this.w;
            const y = this.h / 2;
            this.points.push({
                x, y, ox: x, oy: y,
                active: false,
                triggerOffset: 0
            });
        }
    }

    sculpt(mx, my) {
        const radius = 60;
        this.points.forEach(p => {
            const dx = p.x - mx;
            const dy = p.y - my;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < radius) {
                // Organic push calculation
                const force = (1 - dist/radius) * 0.2; // Gentle sculpting
                
                // Pull towards pointer Y, keep X relatively stable (grid locked)
                p.y += (my - p.y) * force;
                
                // Activation Threshold
                const drift = Math.abs(p.y - p.oy);
                p.active = drift > 10;
            }
        });
    }

    trigger() {
        if(this.muted || !AudioEngine.ctx) return;
        
        const t = AudioEngine.ctx.currentTime;
        const osc = AudioEngine.ctx.createOscillator();
        const gain = AudioEngine.ctx.createGain();
        const filter = AudioEngine.ctx.createBiquadFilter();

        // Tone Shaping based on Layer Type
        if(this.cfg.type === 'KICK') {
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
            gain.gain.setValueAtTime(this.params.vol, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
        } else if(this.cfg.type === 'SNARE') {
            osc.type = 'triangle'; // simplified snare
            osc.frequency.setValueAtTime(200, t);
            gain.gain.setValueAtTime(this.params.vol, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
        } else {
            // Melodic / Tonal
            osc.type = this.cfg.type === 'BASS' ? 'sawtooth' : 'triangle';
            osc.frequency.value = this.cfg.note;
            
            // Filter envelope
            filter.frequency.setValueAtTime(this.params.vol * 2000, t);
            filter.frequency.exponentialRampToValueAtTime(100, t + this.params.decay);
            
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(this.params.vol * 0.5, t + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, t + this.params.decay + 0.2);
        }

        osc.connect(filter);
        filter.connect(gain);
        gain.connect(AudioEngine.compressor);
        
        osc.start(t);
        osc.stop(t + 2);
    }

    draw(playheadX) {
        this.ctx.clearRect(0,0,this.w, this.h);
        
        // Draw Guide Line
        this.ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        this.ctx.beginPath();
        this.ctx.moveTo(0, this.h/2);
        this.ctx.lineTo(this.w, this.h/2);
        this.ctx.stroke();

        // Draw The Clay Mesh
        this.ctx.strokeStyle = this.cfg.color;
        this.ctx.lineWidth = 2;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        
        this.ctx.beginPath();
        if(this.points.length > 0) {
            this.ctx.moveTo(this.points[0].x, this.points[0].y);
            // Spline interpolation for organic look
            for (let i = 0; i < this.points.length - 1; i++) {
                const p0 = this.points[i];
                const p1 = this.points[i + 1];
                const mx = (p0.x + p1.x) * 0.5;
                const my = (p0.y + p1.y) * 0.5;
                this.ctx.quadraticCurveTo(p0.x, p0.y, mx, my);
            }
        }
        this.ctx.stroke();

        // Fill under curve for "Landscape" feel
        this.ctx.lineTo(this.w, this.h);
        this.ctx.lineTo(0, this.h);
        this.ctx.fillStyle = this.cfg.color + '11'; // Very faint fill
        this.ctx.fill();

        // Trigger Check & Visuals
        const stepWidth = this.w / 32;
        
        for(let p of this.points) {
            if(p.active) {
                // Draw nodes if active
                this.ctx.fillStyle = this.cfg.color;
                this.ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
                
                // Playhead collision
                if(AudioEngine.isPlaying && Math.abs(p.x - playheadX) < stepWidth/2) {
                    if(!p.wasTriggered) {
                        this.trigger();
                        p.wasTriggered = true;
                        // Flash effect
                        this.ctx.fillStyle = '#fff';
                        this.ctx.beginPath();
                        this.ctx.arc(p.x, p.y, 6, 0, Math.PI*2);
                        this.ctx.fill();
                    }
                } else {
                    p.wasTriggered = false;
                }
            }
        }
    }
}

// --- MAIN CONTROLLER ---
const container = document.getElementById('strata');
const instances = [];

// Init Layers
LAYERS.forEach(cfg => {
    instances.push(new StrataLayer(cfg, container));
});

// Resize Observer
const ro = new ResizeObserver(() => instances.forEach(i => i.resize()));
ro.observe(container);

// Animation Loop
let phase = 0;
function loop() {
    requestAnimationFrame(loop);
    
    // Playhead logic
    if(AudioEngine.isPlaying) {
        phase += 0.002; // Speed
        if(phase > 1) phase = 0;
    }
    
    const w = container.clientWidth;
    const px = phase * w;

    // Render all layers
    instances.forEach(layer => layer.draw(px));

    // Draw Global Playhead overlay (optional visual aid)
    // In a real app, this might be a separate overlay canvas for performance,
    // but here we just let the logic drive the layers.
}

// Controls
const btnPlay = document.getElementById('btn-play');
btnPlay.addEventListener('click', () => {
    const p = AudioEngine.toggle();
    btnPlay.innerText = p ? 'STOP' : 'PLAY';
    btnPlay.classList.toggle('active', p);
});

document.getElementById('btn-reset').addEventListener('click', () => {
    instances.forEach(i => i.initMesh());
});

loop();

</script>
</body>
</html>
