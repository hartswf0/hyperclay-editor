<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LightOS + Victor Toolkit Demo</title>
<style>
:root { --bg: #001424; --fg: #F9F9F9; --accent: #36CFC9; --warn: #FFB400; }
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--fg); font-family: 'Inter', sans-serif; overflow: hidden; }
#canvas { position: fixed; inset: 0; }
.victor-ui { position: fixed; inset: 0; pointer-events: none; z-index: 100; }
.view-switcher { position: absolute; top: 20px; left: 20px; display: flex; gap: 8px; pointer-events: auto; }
.view-switcher button { background: rgba(54, 207, 201, 0.2); border: 2px solid var(--accent); color: var(--fg); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
.view-switcher button.active { background: var(--accent); color: #001424; }
.controls-panel { position: absolute; top: 80px; left: 20px; background: rgba(0, 20, 36, 0.95); border: 2px solid var(--accent); border-radius: 12px; padding: 20px; width: 320px; pointer-events: auto; }
.panel-title { font-size: 1.2rem; font-weight: 800; color: var(--accent); margin-bottom: 16px; }
.parameter-scrubber { margin-bottom: 20px; }
.parameter-scrubber label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--warn); }
input[type="range"] { width: 100%; height: 6px; border-radius: 3px; background: rgba(54, 207, 201, 0.3); outline: none; -webkit-appearance: none; appearance: none; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; }
input[type="number"] { width: 70px; background: rgba(0, 0, 0, 0.4); border: 1px solid var(--accent); color: var(--fg); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem; }
.scrubber-controls { display: flex; gap: 8px; align-items: center; }
.metadata-list { background: rgba(54, 207, 201, 0.1); border-radius: 8px; padding: 12px; margin-top: 16px; font-size: 0.9rem; max-height: 200px; overflow-y: auto; }
.metadata-item { padding: 8px; border-bottom: 1px solid rgba(54, 207, 201, 0.2); cursor: pointer; transition: background 0.2s; }
.metadata-item:hover { background: rgba(54, 207, 201, 0.2); }
.metadata-tag { display: inline-block; background: var(--accent); color: #001424; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 6px; font-weight: 600; }
.view-container { position: absolute; top: 80px; right: 20px; width: 400px; background: rgba(0, 20, 36, 0.95); border: 2px solid var(--accent); border-radius: 12px; padding: 20px; pointer-events: auto; display: none; }
.view-container.active { display: block; }
canvas.graph { width: 100%; height: 200px; background: rgba(0, 0, 0, 0.4); border-radius: 6px; }
.export-btn { background: var(--warn); color: #001424; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 16px; width: 100%; }
.intro-btn { position: absolute; top: 20px; right: 20px; background: var(--accent); color: #001424; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer; pointer-events: auto; z-index: 200; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,212,255,0.4); }
.intro-btn:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(0,212,255,0.6); }
.intro-btn.playing { background: #ff6b35; }

@media (max-width: 768px) {
  .view-switcher { flex-wrap: wrap; width: calc(100% - 40px); }
  .view-switcher button { flex: 1; min-width: 75px; padding: 6px 10px; font-size: 0.85rem; }
  .controls-panel { top: 140px; left: 10px; right: 10px; width: auto; max-height: 43vh; }
  .view-container { top: auto; bottom: 10px; left: 10px; right: 10px; width: auto; max-height: 45vh; }
  .panel-title { font-size: 1rem; }
  .metadata-list { max-height: 150px; font-size: 0.85rem; }
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<div class="victor-ui">
  <button class="intro-btn" id="play-intro">▶ Play Intro</button>
  
  <div class="view-switcher">
    <button class="active" data-view="visual">Visual</button>
    <button data-view="metadata">Metadata Rooms</button>
    <button data-view="graph">Beam Intensity</button>
  </div>
  
  <div class="controls-panel">
    <div class="panel-title">🗼 LightOS Controls</div>
    
    <div id="rotation-speed"></div>
    <div id="beam-intensity"></div>
    
    <div class="metadata-list">
      <div style="font-weight: 700; color: var(--accent); margin-bottom: 8px;">Metadata Rooms</div>
      <div class="metadata-item" data-room="0">
        <span class="metadata-tag">#urgent</span>
        <span>3 items</span>
      </div>
      <div class="metadata-item" data-room="1">
        <span class="metadata-tag">#draft</span>
        <span>7 items</span>
      </div>
      <div class="metadata-item" data-room="2">
        <span class="metadata-tag">#archived</span>
        <span>12 items</span>
      </div>
      <div class="metadata-item" data-room="3">
        <span class="metadata-tag">#reviewed</span>
        <span>5 items</span>
      </div>
    </div>
    
    <button class="export-btn" id="export-btn">📦 Export Config</button>
  </div>
  
  <div class="view-container" data-view="metadata">
    <div class="panel-title">📊 Metadata Density</div>
    <canvas id="density-canvas" class="graph"></canvas>
    <p style="margin-top: 12px; font-size: 0.85rem; opacity: 0.8;">
      Each room represents a tag category. Size = number of tagged objects.
    </p>
  </div>
  
  <div class="view-container" data-view="graph">
    <div class="panel-title">💡 Beam Intensity Over Time</div>
    <canvas id="intensity-canvas" class="graph"></canvas>
  </div>
</div>

<script type="importmap">
{"imports": {"three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const canvas = document.getElementById('canvas');
const scene = new THREE.Scene();
// Billout maritime palette - deep twilight blue
scene.background = new THREE.Color(0x001424);
// Dense fog for lighthouse mystery
scene.fog = new THREE.FogExp2(0x001424, 0.015);

const camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 0.1, 200);
camera.position.set(8, 6, 12);

const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;

const controls = new OrbitControls(camera, canvas);
controls.enableDamping = true;

const state = { rotationSpeed: 0.4, beamIntensity: 0.7 };

// Ocean
const sea = new THREE.Mesh(new THREE.PlaneGeometry(150, 150, 64, 64), new THREE.MeshStandardMaterial({ color: 0x0a1a2a, transparent: true, opacity: 0.9, roughness: 0.3, metalness: 0.7 }));
sea.rotation.x = -Math.PI / 2;
sea.position.y = -1.5;
sea.receiveShadow = true;
scene.add(sea);

// Pier
const pier = new THREE.Mesh(new THREE.BoxGeometry(3.5, 0.5, 25), new THREE.MeshStandardMaterial({ color: 0x5a4a3a, roughness: 0.9 }));
pier.position.set(0, 0, -8);
pier.castShadow = true;
scene.add(pier);

// Lighthouse
const lighthouse = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.4, 10, 24), new THREE.MeshStandardMaterial({ color: 0xf0f0f0, roughness: 0.4, metalness: 0.2 }));
lighthouse.position.set(0, 5, -18);
lighthouse.castShadow = true;
scene.add(lighthouse);

const lightTop = new THREE.Mesh(new THREE.CylinderGeometry(1.3, 1.3, 1.5, 16), new THREE.MeshStandardMaterial({ color: 0xffb400, emissive: 0xffb400, emissiveIntensity: 0.8, roughness: 0.2, metalness: 0.8 }));
lightTop.position.set(0, 10.5, -18);
scene.add(lightTop);

// Light beam (walkable)
const lightBeam = new THREE.Group();
lightBeam.position.set(0, 10, -18);

const beamMesh = new THREE.Mesh(new THREE.CylinderGeometry(3, 0.5, 25, 16), new THREE.MeshStandardMaterial({ color: 0x36cfc9, transparent: true, opacity: 0.75, emissive: 0x36cfc9, emissiveIntensity: 0.7, side: THREE.DoubleSide }));
beamMesh.rotation.x = Math.PI / 2;
beamMesh.position.z = 12;
beamMesh.castShadow = true;
lightBeam.add(beamMesh);

// Metadata rooms
const rooms = [
  { pos: 5, color: 0xff6b35, count: 3 },
  { pos: 10, color: 0xffb400, count: 7 },
  { pos: 15, color: 0x36cfc9, count: 12 },
  { pos: 20, color: 0x9966ff, count: 5 }
];

rooms.forEach((room, i) => {
  const metaRoom = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), new THREE.MeshStandardMaterial({ color: room.color, emissive: room.color, emissiveIntensity: 0.6, transparent: true, opacity: 0.7 }));
  metaRoom.position.set(0, 0, room.pos);
  metaRoom.userData.isMetaRoom = true;
  metaRoom.userData.roomIndex = i;
  metaRoom.userData.count = room.count;
  lightBeam.add(metaRoom);
});

scene.add(lightBeam);

// Minimal ambient - let the lighthouse dominate
scene.add(new THREE.AmbientLight(0x0a1a2a, 0.2));
scene.add(new THREE.HemisphereLight(0x1a3a4a, 0x001424, 0.3));

// Powerful lighthouse beam spotlight
const beamSpot = new THREE.SpotLight(0x36cfc9, 3, 50, Math.PI / 4, 0.3, 1.2);
beamSpot.position.set(0, 10, -18);
beamSpot.target.position.set(0, 10, 10);
beamSpot.castShadow = true;
scene.add(beamSpot);
scene.add(beamSpot.target);

// Moonlight from above (Billout's calm light)
const moonLight = new THREE.DirectionalLight(0x8aaaaa, 0.5);
moonLight.position.set(-20, 25, -30);
moonLight.castShadow = true;
scene.add(moonLight);

// Controls
function createScrubber(container, label, min, max, value, onChange) {
  const div = document.createElement('div');
  div.className = 'parameter-scrubber';
  div.innerHTML = `<label>${label}</label><div class="scrubber-controls"><input type="range" min="${min}" max="${max}" step="${(max-min)/100}" value="${value}"><input type="number" min="${min}" max="${max}" step="${(max-min)/100}" value="${value}"></div>`;
  const [slider, number] = div.querySelectorAll('input');
  const handle = e => { slider.value = number.value = e.target.value; onChange(+e.target.value); };
  slider.oninput = number.oninput = handle;
  container.appendChild(div);
}

createScrubber(document.getElementById('rotation-speed'), 'Rotation Speed', 0.1, 1, state.rotationSpeed, v => state.rotationSpeed = v);
createScrubber(document.getElementById('beam-intensity'), 'Beam Intensity', 0.3, 1, state.beamIntensity, v => state.beamIntensity = v);

// Metadata density chart
const densityCanvas = document.getElementById('density-canvas');
const densityCtx = densityCanvas.getContext('2d');
densityCanvas.width = 360;
densityCanvas.height = 200;

function drawDensityChart() {
  densityCtx.fillStyle = 'rgba(0,0,0,0.4)';
  densityCtx.fillRect(0, 0, 360, 200);
  
  const barWidth = 80;
  const spacing = 10;
  
  rooms.forEach((room, i) => {
    const x = spacing + i * (barWidth + spacing);
    const height = (room.count / 12) * 160;
    const y = 200 - height;
    
    densityCtx.fillStyle = `#${room.color.toString(16).padStart(6, '0')}`;
    densityCtx.fillRect(x, y, barWidth, height);
    
    densityCtx.fillStyle = '#fff';
    densityCtx.font = '12px Inter';
    densityCtx.textAlign = 'center';
    densityCtx.fillText(`${room.count}`, x + barWidth / 2, y - 5);
  });
}

// Intensity graph
const intensityCanvas = document.getElementById('intensity-canvas');
const intensityCtx = intensityCanvas.getContext('2d');
intensityCanvas.width = 360;
intensityCanvas.height = 200;
const intensityHistory = [];

function updateIntensityGraph() {
  const intensity = beamMesh.material.emissiveIntensity;
  intensityHistory.push(intensity);
  if (intensityHistory.length > 100) intensityHistory.shift();
  
  intensityCtx.fillStyle = 'rgba(0,0,0,0.4)';
  intensityCtx.fillRect(0, 0, 360, 200);
  
  intensityCtx.strokeStyle = '#36cfc9';
  intensityCtx.lineWidth = 2;
  intensityCtx.beginPath();
  
  intensityHistory.forEach((val, i) => {
    const x = (i / 100) * 360;
    const y = 200 - val * 180;
    i === 0 ? intensityCtx.moveTo(x, y) : intensityCtx.lineTo(x, y);
  });
  
  intensityCtx.stroke();
}

document.getElementById('export-btn').onclick = () => {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'light-config.json';
  a.click();
};

document.querySelectorAll('.view-switcher button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.view-switcher button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.view-container').forEach(c => c.classList.remove('active'));
    const vc = document.querySelector(`.view-container[data-view="${btn.dataset.view}"]`);
    if (vc) vc.classList.add('active');
  };
});

let time = 0;
function animate() {
  requestAnimationFrame(animate);
  time += 0.016;
  
  lightBeam.rotation.y = time * state.rotationSpeed;
  beamMesh.material.emissiveIntensity = state.beamIntensity * (0.5 + Math.sin(time * 2) * 0.3);
  
  lightBeam.children.forEach(child => {
    if (child.userData.isMetaRoom) {
      child.rotation.x = time * 0.8;
      child.rotation.y = time * 1.2;
    }
  });
  
  drawDensityChart();
  updateIntensityGraph();
  
  controls.update();
  renderer.render(scene, camera);
}

// ===== AUDIO + TITLE SEQUENCE =====
class SoundEngine {
  constructor() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
  play(f, d, t = 'sine', v = 0.3) {
    const o = this.ctx.createOscillator(), g = this.ctx.createGain();
    o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
    g.gain.setValueAtTime(v, this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
    o.connect(g); g.connect(this.ctx.destination);
    o.start(this.ctx.currentTime); o.stop(this.ctx.currentTime + d);
  }
  sweep(s, e, d, v = 0.15) {
    const o = this.ctx.createOscillator(), g = this.ctx.createGain();
    o.type = 'sine'; o.frequency.setValueAtTime(s, this.ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(e, this.ctx.currentTime + d);
    g.gain.setValueAtTime(v, this.ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
    o.connect(g); g.connect(this.ctx.destination);
    o.start(this.ctx.currentTime); o.stop(this.ctx.currentTime + d);
  }
}
const sound = new SoundEngine();

class TitleSequence {
  constructor(cam, scn, dur = 12) {
    this.cam = cam; this.scn = scn; this.dur = dur; this.playing = false;
    this.origPos = cam.position.clone(); this.origRot = cam.rotation.clone();
    this.sprites = [];
  }
  makeTxt(txt, col = '#00D4FF', sz = 120) {
    const c = document.createElement('canvas'), x = c.getContext('2d');
    c.width = 1024; c.height = 256;
    x.font = `600 ${sz}px 'Helvetica Neue', 'Futura', 'Arial', sans-serif`;
    x.textAlign = 'center'; x.textBaseline = 'middle';
    x.strokeStyle = '#000'; x.lineWidth = 8; x.strokeText(txt, 512, 128);
    x.fillStyle = col; x.fillText(txt, 512, 128);
    const tex = new THREE.CanvasTexture(c); tex.needsUpdate = true;
    const spr = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: 0 }));
    spr.scale.set(10, 2.5, 1); this.scn.add(spr); this.sprites.push(spr); return spr;
  }
  lerp(a, b, t) { return a + (b - a) * t; }
  play() {
    if (this.playing) return; this.playing = true;
    const btn = document.getElementById('play-intro');
    btn.classList.add('playing'); btn.textContent = '⏸ Playing...';
    document.querySelector('.view-switcher').style.opacity = '0';
    document.querySelector('.controls-panel').style.opacity = '0';
    const ce = controls.enabled; controls.enabled = false;
    
    const start = Date.now(), dur = this.dur * 1000;
    const t1 = this.makeTxt('LIGHT', '#00D4FF', 140);
    const t2 = this.makeTxt('BECOMES', '#FFB400', 130);
    const t3 = this.makeTxt('SPACE', '#00D4FF', 140);
    
    setTimeout(() => sound.sweep(800, 1200, 2), 0);
    setTimeout(() => sound.play(1000, 0.3, 'sine'), 3000);
    setTimeout(() => sound.sweep(1200, 800, 2), 6000);
    setTimeout(() => sound.play(900, 1, 'sine'), 9000);
    
    const anim = () => {
      const el = Date.now() - start, t = Math.min(el / dur, 1);
      
      if (t < 0.25) {
        const t1v = t / 0.25, a = t1v * Math.PI * 0.5;
        camera.position.set(Math.cos(a) * 10, this.lerp(8, 12, t1v), Math.sin(a) * 10);
        camera.lookAt(lighthouse.position);
        t1.position.copy(lighthouse.position); t1.position.y += 12;
        t1.material.opacity = t1v; t1.scale.setScalar(this.lerp(0.5, 1, t1v) * 12);
      } else if (t < 0.5) {
        const t2v = (t - 0.25) / 0.25;
        camera.position.set(this.lerp(0, 5, t2v), this.lerp(12, 16, t2v), this.lerp(10, 12, t2v));
        camera.lookAt(lighthouse.position);
        t1.material.opacity = 1 - t2v;
        t2.position.set(0, 10, 0); t2.material.opacity = t2v;
        t2.scale.setScalar(this.lerp(0.5, 1, t2v) * 10);
      } else if (t < 0.75) {
        const t3v = (t - 0.5) / 0.25;
        camera.position.set(this.lerp(5, 2, t3v), this.lerp(16, 22, t3v), this.lerp(12, 0, t3v));
        camera.lookAt(new THREE.Vector3(0, 10, -15));
        t2.material.opacity = 1 - t3v;
        t3.position.set(0, 12, -10); t3.material.opacity = t3v;
        t3.scale.setScalar(this.lerp(0.5, 1, t3v) * 9);
      } else {
        const t4v = (t - 0.75) / 0.25;
        camera.position.set(this.lerp(2, 0, t4v), this.lerp(22, 20, t4v), this.lerp(0, 5, t4v));
        camera.lookAt(new THREE.Vector3(0, 10, -15));
        t3.material.opacity = 1; t3.position.y = 8;
        if (t > 0.95) {
          const fo = (t - 0.95) / 0.05;
          t3.material.opacity = 1 - fo;
        }
      }
      
      if (t < 1) requestAnimationFrame(anim);
      else {
        this.playing = false; btn.classList.remove('playing'); btn.textContent = '▶ Play Intro';
        document.querySelector('.view-switcher').style.opacity = '1';
        document.querySelector('.controls-panel').style.opacity = '1';
        controls.enabled = ce;
        this.sprites.forEach(s => this.scn.remove(s)); this.sprites = [];
        camera.position.copy(this.origPos); camera.rotation.copy(this.origRot);
      }
    };
    anim();
  }
}

const titleSeq = new TitleSequence(camera, scene, 12);
document.getElementById('play-intro').onclick = () => titleSeq.play();

animate();

window.onresize = () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
};
</script>

</body>
</html>
